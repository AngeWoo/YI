<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產調分析表 - 一如土地交易競價看板</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        /* --- 全局與字體設定 --- */
        :root {
            --primary-color: #DC2626;
            --secondary-color: #059669;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-light: #f7f9fc;
            --bg-white: #ffffff;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f1f5f9;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23d1dce9' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v18.5l-13 7.5L0 33.5V15z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- 頂部橫幅設計 (MODIFIED) --- */
        .header {
            background: linear-gradient(to right, #fff5f5, #ffdddd);
            color: var(--text-dark); /* Changed for readability on light background */
            padding: 30px 5%;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* Softened shadow */
            border-bottom: 4px solid var(--primary-color);
        }

        .title-container {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .logo {
            width: 60px;
            height: auto;
        }

        .header h1 {
            font-size: 2.5rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1); /* Softened shadow */
            margin: 0;
            color: var(--primary-color); /* Ensured title color is primary red */
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .back-button {
            display: inline-block;
            padding: 12px 25px;
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            background: var(--secondary-color);
        }

        .back-button:hover {
            transform: translateY(-3px);
            background: #06c284;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
        }
        
        /* --- 全寬內容區塊 --- */
        .analysis-section {
            background: var(--bg-white);
            margin: 20px auto;
            padding: 30px 5%; /* Responsive padding */
            max-width: 1600px; /* Optional: to prevent it being too wide on very large screens */
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .analysis-section:nth-of-type(even) {
            background: var(--bg-light);
        }

        .section-title {
            font-size: 1.8rem;
            color: var(--text-dark);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* --- 通用元件樣式 --- */
        .property-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 12px 18px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-light);
        }

        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            background: var(--bg-white);
            border-radius: 8px;
            overflow: hidden;
        }

        .analysis-table th, .analysis-table td {
            border: 1px solid var(--border-color);
            padding: 12px 10px;
            text-align: center;
            vertical-align: middle;
        }

        .analysis-table th {
            background-color: #f1f5f9;
            font-weight: 600;
        }
        
        .analysis-table .sub-header {
            background-color: #f8fafc;
            font-size: 12px;
        }

        .analysis-table .zone-cell {
            background-color: #fee2e2;
            color: #b91c1c;
            font-weight: bold;
        }
        
        .analysis-table .subtotal-row td {
            background-color: #fefce8;
            font-weight: bold;
        }

        .gis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        .streetview-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            background: var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .gis-card {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .gis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .gis-card h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .open-map-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .open-map-btn:hover {
            filter: brightness(1.1);
        }
        
        .real-price-table th {
            background-color: var(--secondary-color);
            color: white;
        }
        .real-price-table .price-highlight {
            font-weight: bold;
            color: #c62828;
        }

        .real-price-table tbody tr:hover {
            background-color: #e0f2f1;
        }
        
        .map-container { height: 400px; border-radius: 8px; overflow: hidden; background: #e2e8f0; }
        .streetview-section .streetview-container { margin-top: 20px; }

        /* --- 響應式調整 --- */
        @media (max-width: 768px) {
            body { padding: 0; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8rem; }
            .logo { width: 45px; }
            .analysis-section { padding: 20px 15px; margin-bottom: 10px; border-radius: 0; }
            .section-title { font-size: 1.5rem; }
            .gis-grid { grid-template-columns: 1fr; }
            .analysis-table { font-size: 12px; }
            .analysis-table th, .analysis-table td { padding: 8px 5px; }
            .streetview-container, .map-container { height: 350px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="title-container">
            <img src="logo.png" alt="一如 YIRU Logo" class="logo">
            <h1>一如永續產調分析表(基本版)</h1>
        </div>
    </header>

    <div class="action-buttons">
        <a href="index.html" class="back-button">← 返回看板</a>
    </div>

    <main>
        <section class="analysis-section land-section">
            <h2 class="section-title">📜 土地部份</h2>
            <div class="property-info">
                <span><strong>土地部份</strong></span>
                <span id="landAddress" style="max-width: 70%;"><strong>地段:載入中...</strong></span>
            </div>
            <table class="analysis-table">
                <thead>
                    <tr>
                        <th rowspan="2">地號</th><th rowspan="2">土地<br>分區</th><th>公告現值 (114年)</th><th colspan="2">面積</th><th rowspan="2">所有權<br>人數</th><th colspan="2">土地持分</th><th colspan="3">伊土地持分面積</th><th colspan="1">有無地上物</th>
                    </tr>
                    <tr class="sub-header">
                        <th>元/m²</th><th>m²</th><th>坪</th><th>分子</th><th>分母</th><th>m²</th><th>坪</th><th>比例</th><th>地上物建號</th>
                    </tr>
                </thead>
                <tbody id="landTableBody"></tbody>
            </table>
        </section>

        <section class="analysis-section building-section">
            <h2 class="section-title">🏗️ 地上物部份</h2>
            <div class="property-info">
                <span><strong>地上物部份</strong></span>
                <span id="buildingAddress"><strong>地址:載入中...</strong></span>
            </div>
            <table class="analysis-table">
                <thead>
                    <tr>
                        <th rowspan="2">建號</th><th rowspan="2">所含樓<br>層</th><th rowspan="2">建物所有權<br>人數</th><th colspan="2">建物面積</th><th colspan="2">建物持分</th><th colspan="3">建物持分面積</th><th rowspan="2">備註</th>
                    </tr>
                    <tr class="sub-header">
                        <th>m²</th><th>坪</th><th>分子</th><th>分母</th><th>m²</th><th>坪</th><th>比例</th>
                    </tr>
                </thead>
                <tbody id="buildingTableBody"></tbody>
            </table>
        </section>

        <section class="analysis-section gis-section">
            <h2 class="section-title">🗺️ GIS 圖資展示</h2>
            <div class="gis-grid">
                <div class="gis-card"><h3><span>土地使用分區圖</span><button class="open-map-btn" onclick="openExternalMap('zoning')">放大地圖</button></h3><div class="map-container" id="zoningMap"></div></div>
                <div class="gis-card"><h3><span>地籍圖</span><button class="open-map-btn" onclick="openExternalMap('cadastral')">放大地圖</button></h3><div class="map-container" id="cadastralMap"></div></div>
                <div class="gis-card"><h3><span>地形圖</span><button class="open-map-btn" onclick="openExternalMap('topographic')">放大地圖</button></h3><div class="map-container" id="topographicMap"></div></div>
                <div class="gis-card"><h3><span>航照圖</span><button class="open-map-btn" onclick="openExternalMap('aerial')">放大地圖</button></h3><div class="map-container" id="aerialMap"></div></div>
            </div>
        </section>

        <section class="analysis-section streetview-section">
            <h2 class="section-title">📸 Google 街景圖</h2>
            <div class="streetview-container" id="streetviewContainer"></div>
        </section>

        <section class="analysis-section real-price-section">
            <h2 class="section-title">💰 鄰近實價登錄資訊</h2>
            <table class="analysis-table real-price-table">
                <thead>
                    <tr>
                        <th>交易時間</th><th>地址/地段</th><th>型態</th><th>總價</th><th>土地坪數</th><th>單價</th><th>備註</th>
                    </tr>
                </thead>
                <tbody id="realPriceTableBody"></tbody>
            </table>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        const PING_TO_M2 = 3.305785;
        let currentCoords = [25.0330, 121.5654];
        
        function getLandData() {
            const storedData = sessionStorage.getItem('selectedLand');
            let baseData = {};
            if (storedData) {
                baseData = JSON.parse(storedData);
            }
            const defaults = {
                id: new URLSearchParams(window.location.search).get('landId') || Math.floor(Math.random() * 100) + 1,
                title: "高雄市鼓山區農地3地號",
                region: "高雄市", district: "鼓山區", area: 60.19, pricePerPing: 130.5,
                landUseZone: ["住宅區", "商業區", "工業一", "農業區", "保護區"][Math.floor(Math.random() * 5)],
                ownerCount: Math.floor(Math.random() * 15) + 2,
                shareNumerator: 1, shareDenominator: Math.floor(Math.random() * 15) + 5,
                marketPrice: Math.floor(Math.random() * 50) + 80
            };
            const finalData = { ...defaults, ...baseData };
            finalData.shareNumerator = Math.min(finalData.shareNumerator, finalData.shareDenominator);
            return finalData;
        }

        function renderLandTable(land) {
            const areaM2 = land.area * PING_TO_M2;
            const announcedValuePerM2 = Math.round(land.marketPrice * 10000 / PING_TO_M2);
            const shareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0;
            const shareAreaM2 = areaM2 * shareRatio;
            const shareAreaPing = land.area * shareRatio;
            const sharePercentage = (shareRatio * 100).toFixed(2);
            const buildingDisplay = land.hasBuilding ? land.buildingId : '無';
            const announcedValueDisplay = announcedValuePerM2 > 0 ? announcedValuePerM2.toLocaleString() : '非數值';
            document.getElementById('landAddress').innerHTML = `<strong>地段:${land.title}</strong>`;
            document.getElementById('landTableBody').innerHTML = `<tr><td>${land.id}</td><td class="zone-cell">${land.landUseZone}</td><td>${announcedValueDisplay}</td><td>${areaM2.toFixed(2)}</td><td>${land.area.toFixed(2)}</td><td>${land.ownerCount}</td><td>${land.shareNumerator}</td><td>${land.shareDenominator}</td><td>${shareAreaM2.toFixed(2)}</td><td>${shareAreaPing.toFixed(2)}</td><td>${sharePercentage}%</td><td>${buildingDisplay}</td></tr><tr class="subtotal-row"><td colspan="3">小計</td><td>${areaM2.toFixed(2)}</td><td>${land.area.toFixed(2)}</td><td colspan="3"></td><td>${shareAreaM2.toFixed(2)}</td><td>${shareAreaPing.toFixed(2)}</td><td>${sharePercentage}%</td><td></td></tr>`;
        }
        
        function renderBuildingTable(land) {
            if (!land.hasBuilding) {
                document.getElementById('buildingAddress').innerHTML = `<strong>地址: 無</strong>`;
                document.getElementById('buildingTableBody').innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 20px; color: #666;">此筆土地無地上物</td></tr>`;
                return;
            }
            const streets = ["中正路", "中山路", "成功路", "大業路", "和平路", "建國路", "廣福路"];
            const randomStreet = streets[Math.floor(Math.random() * streets.length)];
            const fullAddress = `${land.region}${land.district}${randomStreet}${Math.floor(Math.random() * 100) + 1}巷${Math.floor(Math.random() * 200) + 1}號`;
            document.getElementById('buildingAddress').innerHTML = `<strong>地址: ${fullAddress}</strong>`;
            const buildingOwners = Math.floor(Math.random() * 15) + 1;
            const buildingShareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0;
            const totalFloors = Math.floor(Math.random() * 3) + 1;
            let totalBuildingAreaM2 = 0, totalShareAreaM2 = 0, tableRowsHTML = '';
            for(let i = 1; i <= totalFloors; i++) {
                const floorAreaPing = (Math.random() * 15 + 10).toFixed(2), floorAreaM2 = (floorAreaPing * PING_TO_M2), floorShareAreaM2 = (floorAreaM2 * buildingShareRatio), floorShareAreaPing = (floorAreaPing * buildingShareRatio);
                totalBuildingAreaM2 += floorAreaM2; totalShareAreaM2 += floorShareAreaM2;
                tableRowsHTML += `<tr>${i===1?`<td rowspan="${totalFloors}">${land.buildingId}</td>`:''}<td>${i}</td>${i===1?`<td rowspan="${totalFloors}">${buildingOwners}</td>`:''}<td>${floorAreaM2.toFixed(2)}</td><td>${floorAreaPing}</td><td>${land.shareNumerator}</td><td>${land.shareDenominator}</td><td>${floorShareAreaM2.toFixed(2)}</td><td>${floorShareAreaPing.toFixed(2)}</td><td>${(buildingShareRatio * 100).toFixed(2)}%</td>${i===1?`<td rowspan="${totalFloors}"></td>`:''}</tr>`;
            }
            const totalBuildingAreaPing = (totalBuildingAreaM2 / PING_TO_M2).toFixed(2), totalShareAreaPing = (totalShareAreaM2 / PING_TO_M2).toFixed(2), totalSharePercentage = ((buildingShareRatio * 100) * totalFloors).toFixed(2);
            document.getElementById('buildingTableBody').innerHTML = tableRowsHTML + `<tr class="subtotal-row"><td colspan="3">小計</td><td>${totalBuildingAreaM2.toFixed(2)}</td><td>${totalBuildingAreaPing}</td><td colspan="2"></td><td>${totalShareAreaM2.toFixed(2)}</td><td>${totalShareAreaPing}</td><td>${totalSharePercentage}%</td><td></td></tr>`;
        }
        
        function renderRealPriceTable(land) {
            let contentHTML = '';
            for (let i = 0; i < 8; i++) {
                const transactionDate = `114/${String(Math.floor(Math.random()*5)+1).padStart(2,'0')}`;
                const address = `${land.district}${[ "中正路", "中山路", "成功路", "大業路"][Math.floor(Math.random()*4)]}${Math.floor(Math.random()*200)+1}號`;
                const type = ["住宅用地/建", "商業用地/商", "工業用地/工"][Math.floor(Math.random()*3)];
                const area = land.area*(1+(Math.random()-.5)*.8), unitPrice = land.pricePerPing*(1+(Math.random()-.5)*.6), totalPrice = area*unitPrice;
                contentHTML += `<tr><td style="text-align:center;">${transactionDate}</td><td>${address}</td><td style="text-align:center;">${type}</td><td style="text-align:center;" class="price-highlight">${(totalPrice/1e4).toFixed(1)} 億</td><td style="text-align:center;">${area.toFixed(2)} 坪</td><td style="text-align:center;" class="price-highlight">${unitPrice.toFixed(1)} 萬/坪</td><td style="text-align:center;">${Math.random()>.85?"親友交易":""}</td></tr>`;
            }
            document.getElementById('realPriceTableBody').innerHTML = contentHTML;
        }

        function initializeMaps(land) {
            let coords = [25.0330, 121.5654];
            if (land.region === "桃園市") coords = [24.9936, 121.3010]; else if (land.region === "台中市") coords = [24.1477, 120.6736]; else if (land.region === "台南市") coords = [22.9997, 120.2270]; else if (land.region === "高雄市") coords = [22.6273, 120.3014];
            currentCoords = coords;
            const zoningMap = L.map('zoningMap').setView(coords,16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(zoningMap); L.polygon([[coords[0]+.001,coords[1]-.001],[coords[0]+.001,coords[1]+.001],[coords[0]-.001,coords[1]+.001],[coords[0]-.001,coords[1]-.001]],{color:'#DC2626',fillColor:'#ffcdd2',fillOpacity:.5}).addTo(zoningMap).bindPopup(`使用分區:${land.landUseZone}`);
            const cadastralMap = L.map('cadastralMap').setView(coords,17); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(cadastralMap); L.marker(coords).addTo(cadastralMap).bindPopup(`地號:${land.id}`); L.polygon([[coords[0]+.0008,coords[1]-.0008],[coords[0]+.0008,coords[1]+.0008],[coords[0]-.0008,coords[1]+.0008],[coords[0]-.0008,coords[1]-.0008]],{color:'#2563eb',weight:2,fillOpacity:.1}).addTo(cadastralMap);
            const topographicMap = L.map('topographicMap').setView(coords,15); L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png').addTo(topographicMap); L.marker(coords).addTo(topographicMap).bindPopup(`地形位置`);
            const aerialMap = L.map('aerialMap').setView(coords,18); L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(aerialMap); L.circle(coords,{color:'#059669',fillColor:'#10b981',fillOpacity:.3,radius:50}).addTo(aerialMap).bindPopup('土地位置');
            setTimeout(() => { zoningMap.invalidateSize(); cadastralMap.invalidateSize(); topographicMap.invalidateSize(); aerialMap.invalidateSize(); }, 200);
        }

        function initializeStreetView(land) {
            let coords = currentCoords;
            const streetviewMap = L.map('streetviewContainer').setView(coords, 18); L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(streetviewMap);
            const marker = L.marker(coords).addTo(streetviewMap); const streetviewUrl = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${coords[0]},${coords[1]}`;
            marker.bindPopup(`<div style="text-align:center;"><strong>${land.title}</strong><br><a href="${streetviewUrl}" target="_blank" style="display:inline-block;margin-top:10px;padding:8px 16px;background:linear-gradient(135deg, #4285f4 0%, #34a853 100%);color:white;text-decoration:none;border-radius:6px;font-weight:600;">🌐 開啟 Google 街景</a></div>`).openPopup();
            setTimeout(() => { streetviewMap.invalidateSize(); }, 200);
        }

        function openExternalMap(mapType) {
            let url = `https://www.openstreetmap.org/#map=17/${currentCoords[0]}/${currentCoords[1]}`;
            if (mapType === 'aerial') url = `https://www.google.com/maps/@${currentCoords[0]},${currentCoords[1]},18z/data=!3m1!1e3`;
            window.open(url, '_blank');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const land = getLandData();
            land.hasBuilding = Math.random() > 0.2;
            if (land.hasBuilding) {
                land.buildingId = Math.floor(Math.random() * 5000) + 10000;
            }
            renderLandTable(land); 
            renderBuildingTable(land); 
            renderRealPriceTable(land);
            initializeMaps(land); 
            initializeStreetView(land); 
        });
    </script>
</body>
</html>