<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€å¦‚åœŸåœ° - æˆ°æƒ…ä¸­å¿ƒ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .war-room-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background-color: #fff;
            padding: 20px 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header h1 { color: #DC2626; font-size: 2rem; }
        .header-nav a {
            padding: 10px 20px;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 10px;
        }
        .nav-btn-backend { background-color: #673AB7; }
        .nav-btn-backend:hover { background-color: #512DA8; }
        .nav-btn-home { background-color: #2196F3; }
        .nav-btn-home:hover { background-color: #1976D2; }

        .dashboard-grid {
            padding: 30px 40px;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: minmax(100px, auto);
            gap: 25px;
        }

        .card {
            background-color: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPI Cards */
        .kpi-card { grid-column: span 3; }
        .kpi-value { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
        .kpi-sub-value { font-size: 1rem; color: #666; font-weight: 500;}
        .kpi-change { font-size: 1rem; font-weight: 600; }
        .kpi-change.up { color: #4CAF50; }
        .kpi-change.down { color: #f44336; }

        /* Larger Cards */
        .leaderboard-card { grid-column: span 5; grid-row: span 2; }
        .funnel-card { grid-column: span 7; grid-row: span 2; }
        .city-distribution-card { grid-column: span 6; grid-row: span 2; }
        .source-analysis-card { grid-column: span 6; grid-row: span 2; }
        .hot-districts-card { grid-column: span 12; }

        /* Leaderboard styles */
        .leaderboard-list { list-style: none; }
        .leaderboard-item { display: flex; align-items: center; margin-bottom: 15px; }
        .leaderboard-rank { font-size: 1.2rem; font-weight: bold; color: #999; width: 40px; }
        .leaderboard-rank.top-1 { color: #FFD700; }
        .leaderboard-rank.top-2 { color: #C0C0C0; }
        .leaderboard-rank.top-3 { color: #CD7F32; }
        .leaderboard-info { flex: 1; }
        .leaderboard-name { font-weight: 600; }
        .leaderboard-dept { font-size: 0.8rem; color: #888; }
        .leaderboard-value { font-size: 1.1rem; font-weight: bold; color: #DC2626; }

        /* Sales Funnel */
        .funnel { display: flex; flex-direction: column; gap: 5px; }
        .funnel-stage {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white; padding: 12px 20px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            clip-path: polygon(0% 0%, 100% 0%, 97% 50%, 100% 100%, 0% 100%);
            transition: transform 0.2s;
        }
        .funnel-stage:hover { transform: scale(1.02); }
        .funnel-stage .label { font-weight: bold; }
        .funnel-stage .value { font-size: 1.1rem; }
        .funnel-stage .conversion { font-size: 0.8rem; opacity: 0.8; }
        
        /* Donut Chart */
        .dual-chart-container { display: flex; justify-content: space-around; align-items: center; flex: 1; flex-wrap: wrap; gap: 20px; }
        .chart-group { text-align: center; }
        .donut-chart { width: 150px; height: 150px; border-radius: 50%; position: relative; margin: 0 auto 10px; }
        .donut-chart::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60%; height: 60%; background: #fff; border-radius: 50%; }
        .chart-legend { list-style: none; padding: 0; font-size: 0.9rem; }
        .legend-item { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 5px; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        
        /* Bar Chart */
        .bar-chart-container { list-style: none; flex: 1; display: flex; flex-direction: column; justify-content: space-around; }
        .bar-chart-item { margin-bottom: 15px; }
        .bar-chart-label { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }
        .bar-chart-bar-bg { background-color: #e9ecef; border-radius: 5px; height: 12px; }
        .bar-chart-bar { background: linear-gradient(90deg, #F59E0B, #D97706); height: 100%; border-radius: 5px; }

        /* Hot Districts Table */
        .districts-table { width: 100%; border-collapse: collapse; }
        .districts-table th, .districts-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .districts-table th { font-size: 0.9rem; color: #888; }
        .districts-table td:last-child { font-weight: bold; text-align: right; }

        @media (max-width: 1200px) {
            .kpi-card { grid-column: span 6; }
            .funnel-card { grid-column: span 12; }
            .leaderboard-card { grid-column: span 12; order: 99; } /* move to end */
        }
        @media (max-width: 768px) {
            .header { padding: 15px 20px; flex-direction: column; align-items: flex-start; gap: 10px; }
            .dashboard-grid { padding: 20px; grid-template-columns: 1fr; }
            .card { grid-column: span 1 !important; }
            .kpi-value { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="war-room-container">
        <header class="header">
            <h1>ğŸ¯ ä¸€å¦‚åœŸåœ° - æˆ°æƒ…ä¸­å¿ƒ (War Room)</h1>
            <nav class="header-nav">
                <a href="indexbackend.html" class="nav-btn-backend">ğŸ“Š è¿”å›å¾Œå°</a>
                <a href="index.html" class="nav-btn-home">ğŸ  è¿”å›é¦–é </a>
            </nav>
        </header>

        <main class="dashboard-grid">
            <!-- KPIs ROW 1: Core Metrics -->
            <div class="card kpi-card">
                <div class="card-title">ğŸ“¦ **ç«™å…§æ‰€æœ‰åœŸåœ°ç­†æ•¸**</div>
                <div class="kpi-value" id="kpi-total-listings">0</div>
                <div class="kpi-sub-value" id="kpi-public-listings">0 ç­†å…¬é–‹ä¸­</div>
            </div>
            <div class="card kpi-card">
                <div class="card-title">ğŸ“ˆ **éå»ä¸€å€‹æœˆæˆäº¤è¡¨ç¾**</div>
                <div class="kpi-value" id="kpi-last-month-value">0 è¬</div>
                <div class="kpi-sub-value" id="kpi-last-month-deals">æˆäº¤é‡: 0 ä»¶</div>
            </div>
            <div class="card kpi-card">
                <div class="card-title">ğŸ‘¥ **æœƒå“¡æ•¸ / åœ¨ç·šäººæ•¸**</div>
                <div class="kpi-value" id="kpi-total-members">0</div>
                <div class="kpi-sub-value" id="kpi-online-now">åœ¨ç·šäººæ•¸: 0</div>
            </div>
            <div class="card kpi-card">
                <div class="card-title">ğŸ’° ç¸½æ¡ˆä»¶åƒ¹å€¼ (æ½›åœ¨)</div>
                <div class="kpi-value" id="kpi-total-value">0å„„</div>
                <div class="kpi-change up" id="kpi-total-value-change">+5.2% æœ¬æœˆ</div>
            </div>

            <!-- ROW 2: Inventory & Source Analysis -->
            <div class="card city-distribution-card">
                <div class="card-title">ğŸ™ï¸ **å„ç¸£å¸‚æ¡ˆä»¶åˆ†ä½ˆ**</div>
                <ul class="bar-chart-container" id="city-distribution-chart"></ul>
            </div>
            <div class="card source-analysis-card">
                <div class="card-title">ğŸ” **æ¡ˆä»¶ä¾†æºåˆ†æ (å·²å§”è¨—/æœªå§”è¨—, æœ‰è³£å®¶/å°šç„¡è³£å®¶)**</div>
                <div class="dual-chart-container">
                    <div class="chart-group">
                        <div class="donut-chart" id="consignment-chart"></div>
                        <ul class="chart-legend" id="consignment-legend"></ul>
                    </div>
                    <div class="chart-group">
                        <div class="donut-chart" id="seller-chart"></div>
                        <ul class="chart-legend" id="seller-legend"></ul>
                    </div>
                </div>
            </div>

            <!-- ROW 3: Funnel & Leaderboard -->
            <div class="card funnel-card">
                <div class="card-title">ğŸ’§ æ¥­å‹™é–‹ç™¼æ¼æ–— (æœ¬å­£)</div>
                <div class="funnel" id="sales-funnel"></div>
            </div>
            <div class="card leaderboard-card">
                <div class="card-title">ğŸ† æ¥­å‹™è‹±é›„æ¦œ (æœ¬æœˆæˆäº¤é¡)</div>
                <ul class="leaderboard-list" id="leaderboard"></ul>
            </div>
            
            <!-- ROW 4: Hot Districts -->
            <div class="card hot-districts-card">
                <div class="card-title">ğŸŒ **ç†±é–€è¡Œæ”¿å€æ’è¡Œ (å„å€çµ±è¨ˆ)**</div>
                <table class="districts-table">
                    <thead><tr><th>æ’è¡Œ</th><th>åŸå¸‚</th><th>è¡Œæ”¿å€</th><th>æ¡ˆä»¶æ•¸</th></tr></thead>
                    <tbody id="top-districts-table"></tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            function generateAndRenderData() {
                const formatPrice = (price) => price >= 10000 ? `${(price / 10000).toFixed(1)}å„„` : `${price.toLocaleString()}è¬`;
                
                // --- Mock Data Generation ---
                const salesAgents = [
                    { name: 'ç‹å°æ˜', department: 'åŒ—å€æ¥­å‹™éƒ¨', value: Math.floor(Math.random() * 50000) }, { name: 'æç¾è¯', department: 'åŒ—å€æ¥­å‹™éƒ¨', value: Math.floor(Math.random() * 50000) },
                    { name: 'é™³å»ºåœ‹', department: 'ä¸­å€æ¥­å‹™éƒ¨', value: Math.floor(Math.random() * 50000) }, { name: 'æ—æ·‘èŠ¬', department: 'ä¸­å€æ¥­å‹™éƒ¨', value: Math.floor(Math.random() * 50000) },
                    { name: 'å¼µå¿—å‰›', department: 'å—å€æ¥­å‹™éƒ¨', value: Math.floor(Math.random() * 50000) }, { name: 'é»ƒé›…ç´', department: 'å—å€æ¥­å‹™éƒ¨', value: Math.floor(Math.random() * 50000) }
                ];
                const funnelData = [ { stage: 'æ–°æ¡ˆä»¶', value: 125 }, { stage: 'åˆæ­¥æ¥è§¸', value: 98 }, { stage: 'å¯¦åœ°å‹˜æŸ¥', value: 65 }, { stage: 'è­°åƒ¹ä¸­', value: 31 }, { stage: 'å·²æˆäº¤', value: 15 } ];
                
                // Data for requested metrics
                const lastMonthPerformance = { deals: 22, value: 184560 };
                const totalListings = 852;
                const publicListings = 621;
                const totalMembers = 12543;
                let onlineNow = 178;
                const consignmentData = { consigned: 650, self_listed: 202 };
                const sellerData = { has_seller: 780, no_seller: 72 };
                const cityDistributionData = [
                    { city: "å°ä¸­å¸‚", count: 210 }, { city: "å°åŒ—å¸‚", count: 185 }, { city: "é«˜é›„å¸‚", count: 155 },
                    { city: "æ–°åŒ—å¸‚", count: 140 }, { city: "æ¡ƒåœ’å¸‚", count: 112 }, { city: "å°å—å¸‚", count: 50 }
                ].sort((a,b) => b.count - a.count);
                const topDistrictsData = [
                    { city: "å°ä¸­å¸‚", district: "è¥¿å±¯å€", count: 88 }, { city: "å°åŒ—å¸‚", district: "å¤§å®‰å€", count: 75 },
                    { city: "é«˜é›„å¸‚", district: "å·¦ç‡Ÿå€", count: 62 }, { city: "æ–°åŒ—å¸‚", district: "æ¿æ©‹å€", count: 58 },
                    { city: "æ¡ƒåœ’å¸‚", district: "ä¸­å£¢å€", count: 55 }
                ];

                // --- Render KPIs ---
                document.getElementById('kpi-total-listings').textContent = totalListings.toLocaleString();
                document.getElementById('kpi-public-listings').textContent = `${publicListings} ç­†å…¬é–‹ä¸­`;
                document.getElementById('kpi-last-month-value').textContent = formatPrice(lastMonthPerformance.value);
                document.getElementById('kpi-last-month-deals').textContent = `æˆäº¤é‡: ${lastMonthPerformance.deals} ä»¶`;
                document.getElementById('kpi-total-members').textContent = totalMembers.toLocaleString();
                document.getElementById('kpi-online-now').textContent = `åœ¨ç·šäººæ•¸: ${onlineNow}`;
                document.getElementById('kpi-total-value').textContent = `${(Math.random() * 50 + 100).toFixed(1)}å„„`;

                // --- Render City Distribution Bar Chart ---
                const cityContainer = document.getElementById('city-distribution-chart');
                cityContainer.innerHTML = '';
                const maxCityCount = cityDistributionData[0].count;
                cityDistributionData.forEach(item => {
                    cityContainer.innerHTML += `<li class="bar-chart-item"><div class="bar-chart-label"><span>${item.city}</span><span>${item.count}ä»¶</span></div><div class="bar-chart-bar-bg"><div class="bar-chart-bar" style="width: ${(item.count / maxCityCount) * 100}%;"></div></div></li>`;
                });

                // --- Render Source Analysis Donut Charts ---
                function renderDonutChart(chartId, legendId, data, colors, labels) {
                    const chart = document.getElementById(chartId);
                    const legend = document.getElementById(legendId);
                    legend.innerHTML = '';
                    const total = Object.values(data).reduce((s, v) => s + v, 0);
                    let gradientString = '', currentPercentage = 0;
                    Object.entries(data).forEach(([key, value]) => {
                        const percentage = (value / total) * 100;
                        gradientString += `${colors[key]} ${currentPercentage}% ${currentPercentage + percentage}%, `;
                        currentPercentage += percentage;
                        legend.innerHTML += `<li class="legend-item"><div class="legend-color" style="background-color: ${colors[key]};"></div>${labels[key]} - ${value}ä»¶ (${percentage.toFixed(1)}%)</li>`;
                    });
                    chart.style.background = `conic-gradient(${gradientString.slice(0, -2)})`;
                }
                renderDonutChart('consignment-chart', 'consignment-legend', consignmentData, { consigned: '#36A2EB', self_listed: '#FFCE56' }, { consigned: 'ä¸€å¦‚å§”è¨—', self_listed: 'åœ°ä¸»è‡ªå”®' });
                renderDonutChart('seller-chart', 'seller-legend', sellerData, { has_seller: '#4BC0C0', no_seller: '#FF6384' }, { has_seller: 'æœ‰è³£å®¶', no_seller: 'å°šç„¡è³£å®¶' });

                // --- Render Sales Funnel ---
                const funnelContainer = document.getElementById('sales-funnel');
                funnelContainer.innerHTML = '';
                for (let i = 0; i < funnelData.length; i++) {
                    let rateText = (i > 0) ? `<span class="conversion">è½‰æ›ç‡: ${((funnelData[i].value / funnelData[i-1].value) * 100).toFixed(1)}%</span>` : '';
                    funnelContainer.innerHTML += `<div class="funnel-stage" style="width: ${100 - i*8}%;"><span class="label">${funnelData[i].stage}</span><div style="text-align: right;"><span class="value">${funnelData[i].value} ä»¶</span>${rateText}</div></div>`;
                }
                
                // --- Render Leaderboard ---
                const leaderboardContainer = document.getElementById('leaderboard');
                leaderboardContainer.innerHTML = '';
                salesAgents.sort((a, b) => b.value - a.value).forEach((agent, i) => {
                    leaderboardContainer.innerHTML += `<li class="leaderboard-item"><div class="leaderboard-rank ${i<3?`top-${i+1}`:''}">${i+1}</div><div class="leaderboard-info"><div class="leaderboard-name">${agent.name}</div><div class="leaderboard-dept">${agent.department}</div></div><div class="leaderboard-value">${formatPrice(agent.value)}</div></li>`;
                });

                // --- Render Top Districts Table ---
                const districtsTableBody = document.getElementById('top-districts-table');
                districtsTableBody.innerHTML = '';
                topDistrictsData.forEach((item, i) => {
                    districtsTableBody.innerHTML += `<tr><td>${i+1}</td><td>${item.city}</td><td>${item.district}</td><td>${item.count}</td></tr>`;
                });
            }

            generateAndRenderData();

            setInterval(() => {
                let onlineCount = parseInt(document.getElementById('kpi-online-now').textContent.split(': ')[1]);
                onlineCount += Math.floor(Math.random() * 10 - 5);
                document.getElementById('kpi-online-now').textContent = `åœ¨ç·šäººæ•¸: ${Math.max(50, onlineCount)}`;
            }, 3000);
        });
    </script>
</body>
</html>