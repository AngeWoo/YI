<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢èª¿åˆ†æè¡¨ - ä¸€å¦‚åœŸåœ°äº¤æ˜“ç«¶åƒ¹çœ‹æ¿</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: #DC2626;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.8rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .back-button, .export-pdf-button {
            display: inline-block;
            padding: 10px 20px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .back-button {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
        }

        .export-pdf-button {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .export-pdf-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        .export-pdf-button:disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
            max-width: 1400px;
            margin: 0 auto;
        }

        .analysis-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #DC2626;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 3px solid #DC2626;
        }

        .property-info {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: white;
        }

        .analysis-table th, .analysis-table td {
            border: 1px solid #b0bec5;
            padding: 10px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .analysis-table th {
            background-color: #eceff1;
            font-weight: 600;
            font-size: 13px;
        }
        
        .analysis-table .sub-header {
            background-color: #f5f5f5;
            font-size: 12px;
        }

        .analysis-table .zone-cell {
            background-color: #ffcdd2;
            color: #c62828;
            font-weight: bold;
        }
        
        .analysis-table .subtotal-row td {
            background-color: #fffde7;
            font-weight: bold;
        }

        .gis-section {
            margin-top: 40px;
        }

        .gis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .streetview-section {
            margin-top: 40px;
        }

        .streetview-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            background: #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .streetview-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .gis-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .gis-card h3 {
            color: #0f766e;
            margin-bottom: 10px;
            font-size: 1.1rem;
            padding-bottom: 8px;
            border-bottom: 2px solid #14b8a6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .open-map-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            text-decoration: none;
        }
        
        .open-map-btn.overlay-btn {
             background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        .open-map-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.4);
        }
        
        .open-map-btn.overlay-btn:hover {
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.5);
        }
        
        .real-price-section {
            margin-top: 40px;
        }

        .real-price-table th {
            background-color: #0f766e;
            color: white;
            font-weight: 600;
        }

        .real-price-table td {
            text-align: left;
            padding-left: 15px;
        }
        
        .real-price-table td.center-align {
            text-align: center;
            padding-left: 8px;
        }

        .real-price-table .price-highlight {
            font-weight: bold;
            color: #c62828;
        }

        .real-price-table tbody tr:hover {
            background-color: #e0f2f1;
        }

        .expert-advice-section {
            margin-top: 40px;
        }

        .advice-content {
            background: #fffde7;
            border: 1px solid #fff9c4;
            border-radius: 12px;
            padding: 25px;
            font-size: 15px;
            line-height: 1.8;
            color: #333;
        }

        .advice-content h3 {
            font-size: 1.2rem;
            color: #0f766e;
            margin-top: 15px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #a7ffeb;
        }

        .advice-content h3:first-child {
            margin-top: 0;
        }

        .advice-content ul {
            list-style-type: none;
            padding-left: 0;
        }

        .advice-content li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 10px;
        }

        .advice-content li::before {
            content: 'ğŸ”¹';
            position: absolute;
            left: 0;
            top: 2px;
            color: #14b8a6;
        }

        .advice-content .highlight-good {
            color: #059669;
            font-weight: bold;
        }

        .advice-content .highlight-bad {
            color: #c62828;
            font-weight: bold;
        }

        /* å®ä»·ç™»å½•è§†å›¾åˆ‡æ¢æ ·å¼ */
        .real-price-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .view-toggle-buttons {
            display: flex;
            gap: 10px;
            background: white;
            padding: 4px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .view-toggle-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 600;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-toggle-btn:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .view-toggle-btn.active {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .real-price-view {
            display: none;
        }

        .real-price-view.active {
            display: block;
        }

        /* åœ°å›¾æ§åˆ¶é¢æ¿ */
        .map-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .price-legend {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .legend-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .legend-items {
            display: flex;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #64748b;
        }

        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
        }

        .filter-controls {
            display: flex;
            gap: 20px;
        }

        .filter-controls label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #475569;
            cursor: pointer;
            user-select: none;
        }

        .filter-controls input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* åœ°å›¾ç»Ÿè®¡é¢æ¿ */
        .map-stats {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
        }

        .stat-label {
            display: block;
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .stat-value {
            display: inline-block;
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
        }

        .stat-unit {
            font-size: 14px;
            color: #64748b;
            margin-left: 4px;
        }

        /* åœ°å›¾æ ‡è®°å¼¹çª—æ ·å¼ */
        .custom-popup {
            min-width: 250px;
        }

        .custom-popup .popup-header {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 12px 15px;
            margin: -15px -15px 12px -15px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 14px;
        }

        .custom-popup .popup-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }

        .custom-popup .popup-row:last-child {
            border-bottom: none;
        }

        .custom-popup .popup-label {
            color: #64748b;
        }

        .custom-popup .popup-value {
            font-weight: 600;
            color: #1e293b;
        }

        .custom-popup .popup-price {
            color: #dc2626;
            font-size: 16px;
        }

        .share-analysis-section {
            margin-top: 40px;
        }

        .share-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .share-info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #14b8a6;
        }

        .share-info-card h4 {
            color: #0f766e;
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-info-card .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0f2f1;
        }

        .share-info-card .info-row:last-child {
            border-bottom: none;
        }

        .share-info-card .info-label {
            color: #64748b;
            font-size: 14px;
        }

        .share-info-card .info-value {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .share-info-card .info-value.good {
            color: #059669;
        }

        .share-info-card .info-value.bad {
            color: #dc2626;
        }

        .share-info-card .info-value.warning {
            color: #f59e0b;
        }

        .risk-meter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .risk-meter-bar {
            flex: 1;
            height: 8px;
            background: #e0f2f1;
            border-radius: 4px;
            overflow: hidden;
        }

        .risk-meter-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .risk-meter-fill.low {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .risk-meter-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .risk-meter-fill.high {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .risk-meter-label {
            font-size: 12px;
            font-weight: 600;
            min-width: 40px;
        }

        .integration-strategy {
            background: #f0fdfa;
            border: 2px solid #14b8a6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .integration-strategy h5 {
            color: #0f766e;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .integration-strategy ul {
            list-style: none;
            padding-left: 0;
        }

        .integration-strategy li {
            padding: 5px 0 5px 20px;
            position: relative;
            font-size: 14px;
        }

        .integration-strategy li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }

        .ownership-chart {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .ownership-bar {
            display: flex;
            height: 40px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .ownership-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .ownership-segment:hover {
            filter: brightness(1.1);
            cursor: pointer;
        }

        .ownership-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        @media print {
            .open-map-btn, .action-buttons, .header { display: none !important; }
            body { padding: 0; background: white; }
            .container { margin: 0; padding: 20px; box-shadow: none; border-radius: 0; }
        }

        .pdf-mode .open-map-btn, .pdf-mode .action-buttons { display: none !important; }
        .pdf-mode { background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%) !important; padding: 20px !important; }
        .pdf-mode .container { margin: 0 auto !important; padding: 30px !important; max-width: 1400px !important; }
        .pdf-mode .analysis-table, .pdf-mode .property-info, .pdf-mode .section-title { page-break-inside: avoid; }

        .map-container { height: 350px; border-radius: 8px; overflow: hidden; background: #e2e8f0; }
        .land-section { margin-bottom: 30px; }
        .building-section { margin-top: 30px; }
        
        /* MODIFICATION START: Added styles for amenities map */
        .amenities-section {
            margin-top: 40px;
        }

        .amenities-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        .amenities-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #334155;
            cursor: pointer;
            user-select: none;
        }

        .amenities-controls input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #DC2626;
        }

        .amenity-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            font-weight: bold;
            width: 32px !important;
            height: 32px !important;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /* MODIFICATION END */

        @media (max-width: 968px) {
            .gis-grid { grid-template-columns: 1fr; }
            .share-info-grid { grid-template-columns: 1fr; }
            body { padding: 10px; }
            .container { padding: 15px; }
            .analysis-table { font-size: 12px; }
            .analysis-table th, .analysis-table td { padding: 6px 4px; }
            .map-container { height: 300px; }
            .streetview-container { height: 350px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ä¸€å¦‚æ°¸çºŒç”¢èª¿åˆ†æè¡¨(æœƒå“¡é€²éšç‰ˆ)</h1>
    </div>

    <div class="action-buttons">
        <a href="index.html" class="back-button">â† è¿”å›çœ‹æ¿</a>
        <button onclick="exportToPDF()" class="export-pdf-button" id="exportBtn">ğŸ“„ åŒ¯å‡º PDF</button>
    </div>

    <div class="container" id="pdfContent">
        <div class="analysis-section land-section">
            <h2 class="section-title">åœŸåœ°éƒ¨ä»½</h2>
            <div class="property-info"><span><strong>åœŸåœ°éƒ¨ä»½</strong></span><span id="landAddress" style="max-width: 70%;"><strong>åœ°æ®µ:è¼‰å…¥ä¸­...</strong></span></div>
            <table class="analysis-table">
                <thead>
                    <tr><th rowspan="2">åœ°è™Ÿ</th><th rowspan="2">åœŸåœ°<br>åˆ†å€</th><th>å…¬å‘Šç¾å€¼ (114å¹´)</th><th colspan="2">é¢ç©</th><th rowspan="2">æ‰€æœ‰æ¬Š<br>äººæ•¸</th><th colspan="2">åœŸåœ°æŒåˆ†</th><th colspan="3">ä¼ŠåœŸåœ°æŒåˆ†é¢ç©</th><th colspan="1">æœ‰ç„¡åœ°ä¸Šç‰©</th></tr>
                    <tr class="sub-header"><th>å…ƒ/mÂ²</th><th>mÂ²</th><th>åª</th><th>åˆ†å­</th><th>åˆ†æ¯</th><th>mÂ²</th><th>åª</th><th>æ¯”ä¾‹</th><th>åœ°ä¸Šç‰©å»ºè™Ÿ</th></tr>
                </thead>
                <tbody id="landTableBody"></tbody>
            </table>
        </div>

        <div class="analysis-section building-section">
            <h2 class="section-title">åœ°ä¸Šç‰©éƒ¨ä»½</h2>
            <div class="property-info"><span><strong>åœ°ä¸Šç‰©éƒ¨ä»½</strong></span><span id="buildingAddress"><strong>åœ°å€:è¼‰å…¥ä¸­...</strong></span></div>
            <table class="analysis-table">
                <thead>
                    <tr><th rowspan="2">å»ºè™Ÿ</th><th rowspan="2">æ‰€å«æ¨“<br>å±¤</th><th rowspan="2">å»ºç‰©æ‰€æœ‰æ¬Š<br>äººæ•¸</th><th colspan="2">å»ºç‰©é¢ç©</th><th colspan="2">å»ºç‰©æŒåˆ†</th><th colspan="3">å»ºç‰©æŒåˆ†é¢ç©</th><th rowspan="2">å‚™è¨»</th></tr>
                    <tr class="sub-header"><th>mÂ²</th><th>åª</th><th>åˆ†å­</th><th>åˆ†æ¯</th><th>mÂ²</th><th>åª</th><th>æ¯”ä¾‹</th></tr>
                </thead>
                <tbody id="buildingTableBody"></tbody>
            </table>
        </div>

        <div class="gis-section">
            <h2 class="section-title">GIS åœ–è³‡å±•ç¤º</h2>
            <div class="gis-grid">
                <div class="gis-card"><h3><span>åœŸåœ°ä½¿ç”¨åˆ†å€åœ–</span><button class="open-map-btn" onclick="openExternalMap('zoning')">ğŸ—ºï¸ é–‹å•Ÿåœ°åœ–</button></h3><div class="map-container" id="zoningMap"></div></div>
                <div class="gis-card"><h3><span>åœ°ç±åœ–</span><button class="open-map-btn" onclick="openExternalMap('cadastral')">ğŸ—ºï¸ é–‹å•Ÿåœ°åœ–</button></h3><div class="map-container" id="cadastralMap"></div></div>
                <div class="gis-card"><h3><span>åœ°å½¢åœ–</span><button class="open-map-btn" onclick="openExternalMap('topographic')">ğŸ—ºï¸ é–‹å•Ÿåœ°åœ–</button></h3><div class="map-container" id="topographicMap"></div></div>
                <div class="gis-card"><h3><span>èˆªç…§åœ–</span><button class="open-map-btn" onclick="openExternalMap('aerial')">ğŸ—ºï¸ é–‹å•Ÿåœ°åœ–</button></h3><div class="map-container" id="aerialMap"></div></div>
            </div>
        </div>

        <!-- MODIFICATION START: Added amenities map section -->
        <div class="analysis-section amenities-section">
            <h2 class="section-title">é„°è¿‘ç”Ÿæ´»æ©Ÿèƒ½åœ–</h2>
            <div class="amenities-controls">
                <label><input type="checkbox" data-layer="transport" checked> äº¤é€š</label>
                <label><input type="checkbox" data-layer="school" checked> å­¸æ ¡</label>
                <label><input type="checkbox" data-layer="park" checked> å…¬åœ’</label>
                <label><input type="checkbox" data-layer="shopping" checked> è³¼ç‰©</label>
                <label><input type="checkbox" data-layer="medical" checked> é†«ç™‚</label>
            </div>
            <div class="map-container" id="amenitiesMap" style="height: 500px;"></div>
        </div>
        <!-- MODIFICATION END -->

        <div class="streetview-section">
            <h2 class="section-title">Google è¡—æ™¯åœ–</h2>
            <div class="streetview-container" id="streetviewContainer"></div>
        </div>

        <div class="analysis-section real-price-section">
            <div class="real-price-header">
                <h2 class="section-title">é„°è¿‘å¯¦åƒ¹ç™»éŒ„è³‡è¨Š</h2>
                <div class="view-toggle-buttons">
                    <button class="view-toggle-btn active" onclick="switchRealPriceView('table')">
                        ğŸ“Š è¡¨æ ¼æª¢è¦–
                    </button>
                    <button class="view-toggle-btn" onclick="switchRealPriceView('map')">
                        ğŸ—ºï¸ åœ°åœ–æª¢è¦–
                    </button>
                </div>
            </div>
            
            <!-- è¡¨æ ¼è§†å›¾ -->
            <div id="realPriceTableView" class="real-price-view active">
                <table class="analysis-table real-price-table">
                    <thead><tr><th>ç·¨è™Ÿ</th><th>äº¤æ˜“æ™‚é–“</th><th>åœ°å€/åœ°æ®µ</th><th>å‹æ…‹</th><th>ç¸½åƒ¹</th><th>åœŸåœ°åªæ•¸</th><th>å–®åƒ¹</th><th>å‚™è¨»</th></tr></thead>
                    <tbody id="realPriceTableBody"></tbody>
                </table>
            </div>
            
            <!-- åœ°å›¾è§†å›¾ -->
            <div id="realPriceMapView" class="real-price-view">
                <div class="map-controls">
                    <div class="price-legend">
                        <div class="legend-title">å–®åƒ¹å€é–“ (è¬/åª)</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #10b981;"></span>
                                <span>150ä»¥ä¸‹</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #f59e0b;"></span>
                                <span>150-200</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #ef4444;"></span>
                                <span>200ä»¥ä¸Š</span>
                            </div>
                        </div>
                    </div>
                    <div class="filter-controls">
                        <label>
                            <input type="checkbox" id="filterResidential" checked onchange="updateMapMarkers()"> ä½å®…ç”¨åœ°
                        </label>
                        <label>
                            <input type="checkbox" id="filterCommercial" checked onchange="updateMapMarkers()"> å•†æ¥­ç”¨åœ°
                        </label>
                        <label>
                            <input type="checkbox" id="filterIndustrial" checked onchange="updateMapMarkers()"> å·¥æ¥­ç”¨åœ°
                        </label>
                    </div>
                </div>
                <div class="map-container" id="realPriceMap" style="height: 600px; border-radius: 12px;"></div>
                <div class="map-stats">
                    <div class="stat-item">
                        <span class="stat-label">é¡¯ç¤ºäº¤æ˜“æ•¸</span>
                        <span class="stat-value" id="mapTransactionCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å¹³å‡å–®åƒ¹</span>
                        <span class="stat-value" id="mapAvgPrice">0</span>
                        <span class="stat-unit">è¬/åª</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">æœ€é«˜å–®åƒ¹</span>
                        <span class="stat-value" id="mapMaxPrice">0</span>
                        <span class="stat-unit">è¬/åª</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">æœ€ä½å–®åƒ¹</span>
                        <span class="stat-value" id="mapMinPrice">0</span>
                        <span class="stat-unit">è¬/åª</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="analysis-section share-analysis-section">
            <h2 class="section-title">ğŸ” æŒåˆ†åœ°æ·±åº¦åˆ†æ</h2>
            <div class="share-info-grid">
                <div class="share-info-card">
                    <h4>ğŸ“Š ç”¢æ¬Šçµæ§‹åˆ†æ</h4>
                    <div class="info-row"><span class="info-label">å…±æœ‰äººç¸½æ•¸</span><span class="info-value bad" id="ownerCountDisplay">-</span></div>
                    <div class="info-row"><span class="info-label">æ‚¨çš„æŒåˆ†æ¯”ä¾‹</span><span class="info-value" id="shareRatioDisplay">-</span></div>
                    <div class="info-row"><span class="info-label">å¯¦éš›æŒåˆ†é¢ç©</span><span class="info-value good" id="shareAreaDisplay">-</span></div>
                    <div class="info-row"><span class="info-label">ç”¢æ¬Šé¡å‹</span><span class="info-value" id="ownershipTypeDisplay">-</span></div>
                    <div class="ownership-chart"><div class="ownership-bar" id="ownershipBar"></div><div class="ownership-legend" id="ownershipLegend"></div></div>
                </div>
                <div class="share-info-card">
                    <h4>âš–ï¸ æ³•å¾‹æ¬Šåˆ©èªªæ˜</h4>
                    <div class="info-row"><span class="info-label">å„ªå…ˆè³¼è²·æ¬Š</span><span class="info-value good">âœ“ äº«æœ‰</span></div>
                    <div class="info-row"><span class="info-label">åˆ†å‰²è«‹æ±‚æ¬Š</span><span class="info-value good">âœ“ å¯è¡Œä½¿</span></div>
                    <div class="info-row"><span class="info-label">ä½¿ç”¨æ”¶ç›Šæ¬Š</span><span class="info-value warning">éœ€å”è­°</span></div>
                    <div class="info-row"><span class="info-label">è™•åˆ†æ¬Šé™</span><span class="info-value">å¯å–®ç¨å‡ºå”®æŒåˆ†</span></div>
                    <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 6px; font-size: 13px; line-height: 1.6;"><strong style="color: #92400e;">âš ï¸ é‡è¦æé†’ï¼š</strong><br>â€¢ å‡ºå”®æŒåˆ†éœ€é€šçŸ¥å…¶ä»–å…±æœ‰äºº<br>â€¢ å…¶ä»–å…±æœ‰äººäº«æœ‰å„ªå…ˆè³¼è²·æ¬Š<br>â€¢ å»ºè­°è«®è©¢å°ˆæ¥­åœ°æ”¿å£«å”åŠ©</div>
                </div>
                <div class="share-info-card">
                    <h4>ğŸ’° æŠ•è³‡åƒ¹å€¼è©•ä¼°</h4>
                    <div class="info-row"><span class="info-label">æŒåˆ†å–®åƒ¹</span><span class="info-value" id="shareUnitPriceDisplay">-</span></div>
                    <div class="info-row"><span class="info-label">å®Œæ•´ç”¢æ¬Šå–®åƒ¹</span><span class="info-value" id="fullPriceDisplay">-</span></div>
                    <div class="info-row"><span class="info-label">åƒ¹å·®åˆ†æ</span><span class="info-value good" id="priceDiffDisplay">-</span></div>
                    <div class="info-row"><span class="info-label">æŠ•è³‡ç¸½é¡</span><span class="info-value" id="totalInvestmentDisplay">-</span></div>
                    <div style="margin-top: 15px; padding: 12px; background: #ecfdf5; border-radius: 6px; font-size: 13px; line-height: 1.6;"><strong style="color: #065f46;">ğŸ’¡ æŠ•è³‡å»ºè­°ï¼š</strong><br><span id="investmentAdvice">è¼‰å…¥ä¸­...</span></div>
                </div>
                <div class="share-info-card">
                    <h4>âš ï¸ é¢¨éšªèˆ‡æ•´åˆè©•ä¼°</h4>
                    <div class="info-row"><span class="info-label">æ•´åˆé›£åº¦</span><span class="info-value" id="integrationDifficulty">-</span></div>
                    <div class="risk-meter"><span class="risk-meter-label" id="riskLevel">-</span><div class="risk-meter-bar"><div class="risk-meter-fill" id="riskFill"></div></div></div>
                    <div class="info-row"><span class="info-label">é ä¼°æ•´åˆæ™‚é–“</span><span class="info-value warning" id="integrationTime">-</span></div>
                    <div class="info-row"><span class="info-label">æ•´åˆæˆåŠŸç‡</span><span class="info-value" id="successRate">-</span></div>
                    <div class="integration-strategy" id="integrationStrategy"></div>
                </div>
            </div>
        </div>

        <div class="analysis-section expert-advice-section">
            <h2 class="section-title">å°ˆå®¶å»ºè­°</h2>
            <div class="advice-content" id="expertAdviceContent"></div>
        </div>
        
        <div class="analysis-section">
            <h2 class="section-title">æ‰€æœ‰åœ–è³‡å¥—åœ–</h2>
            <div class="gis-card"><h3><span>å¤šåœ–å±¤å¥—ç–Šé è¦½</span><a href="index6.html" target="_blank" class="open-map-btn overlay-btn">ğŸš€ é–‹å•Ÿå…¨åŠŸèƒ½å¥—åœ–åˆ†æ</a></h3><div class="map-container" id="overlayMap" style="height: 500px;"></div></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        const PING_TO_M2 = 3.305785;
        let currentCoords = [25.0355, 121.565]; 
        
        function getLandData() {
            const storedData = sessionStorage.getItem('selectedLand');
            let baseData = {};
            if (storedData) {
                baseData = JSON.parse(storedData);
            }

            const defaults = {
                id: new URLSearchParams(window.location.search).get('landId') || 101,
                title: "è‡ºåŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©æ®µäº”å°æ®µ101åœ°è™Ÿ",
                region: "è‡ºåŒ—å¸‚", district: "ä¿¡ç¾©å€", area: 150.5,
                pricePerPing: 165.0,
                landUseZone: "å•†æ¥­å€",
                ownerCount: Math.floor(Math.random() * 20) + 1,
                shareNumerator: 1,
                shareDenominator: Math.floor(Math.random() * 20) + 2,
                marketPrice: 175.0
            };
            
            const finalData = { ...defaults, ...baseData };

            if (finalData.ownerCount > 1) {
                 finalData.shareDenominator = Math.max(finalData.shareDenominator, finalData.ownerCount);
                 finalData.shareNumerator = Math.min(finalData.shareNumerator, finalData.shareDenominator);
            } else {
                finalData.shareNumerator = 1;
                finalData.shareDenominator = 1;
            }

            return finalData;
        }

        async function exportToPDF() {
            const button = document.getElementById('exportBtn');
            const originalText = button.innerHTML;
            try {
                button.disabled = true;
                button.innerHTML = 'â³ ç”Ÿæˆä¸­...';
                document.body.classList.add('pdf-mode');
                await new Promise(resolve => setTimeout(resolve, 500));
                const canvas = await html2canvas(document.body, { scale: 2, useCORS: true, allowTaint: true, logging: false, backgroundColor: '#e0f2f1', windowWidth: document.documentElement.scrollWidth, windowHeight: document.documentElement.scrollHeight });
                document.body.classList.remove('pdf-mode');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4', compress: true });
                const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight();
                const ratio = pdfWidth / canvas.width; const imgHeightInPDF = canvas.height * ratio; const totalPages = Math.ceil(imgHeightInPDF / pdfHeight);
                for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                    if (pageNum > 0) pdf.addPage();
                    const startY = (pageNum * pdfHeight) / ratio;
                    const heightToCut = Math.min(pdfHeight / ratio, canvas.height - startY);
                    const pageCanvas = document.createElement('canvas'); pageCanvas.width = canvas.width; pageCanvas.height = heightToCut;
                    const ctx = pageCanvas.getContext('2d');
                    ctx.drawImage(canvas, 0, startY, canvas.width, heightToCut, 0, 0, canvas.width, heightToCut);
                    const imgData = pageCanvas.toDataURL('image/jpeg', 0.95);
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, heightToCut * ratio);
                }
                const land = getLandData();
                const today = new Date(); const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                pdf.save(`ç”¢èª¿åˆ†æè¡¨_${land.title}_${dateStr}.pdf`);
                button.innerHTML = 'âœ… åŒ¯å‡ºæˆåŠŸ!';
                setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
            } catch (error) {
                console.error('åŒ¯å‡º PDF æ™‚ç™¼ç”ŸéŒ¯èª¤:', error); alert('åŒ¯å‡º PDF å¤±æ•—,è«‹ç¨å¾Œå†è©¦ã€‚');
                button.innerHTML = originalText; button.disabled = false; document.body.classList.remove('pdf-mode');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const land = getLandData();

            land.hasBuilding = Math.random() > 0.2; // 80% chance
            if (land.hasBuilding) {
                land.buildingId = Math.floor(Math.random() * 5000) + 10000;
            }

            renderLandTable(land); 
            renderBuildingTable(land); 
            renderRealPriceTable(land); 
            renderShareAnalysis(land);
            renderExpertAdvice(land);
            setTimeout(() => { 
                initializeMaps(land); 
                initializeAmenitiesMap(); // MODIFICATION: Call new function
                initializeStreetView(land); 
            }, 100);
        });

        function renderLandTable(land) {
            const areaM2 = land.area * PING_TO_M2;
            const announcedValuePerM2 = Math.round(land.marketPrice * 10000 / PING_TO_M2);
            const shareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0;
            const shareAreaM2 = areaM2 * shareRatio;
            const shareAreaPing = land.area * shareRatio;
            const sharePercentage = (shareRatio * 100).toFixed(2);
            const buildingDisplay = land.hasBuilding ? land.buildingId : 'ç„¡';
            document.getElementById('landAddress').innerHTML = `<strong>åœ°æ®µ:${land.title}</strong>`;
            document.getElementById('landTableBody').innerHTML = `<tr><td>${land.id}</td><td class="zone-cell">${land.landUseZone}</td><td>${announcedValuePerM2.toLocaleString()}</td><td>${areaM2.toFixed(2)}</td><td>${land.area.toFixed(2)}</td><td>${land.ownerCount}</td><td>${land.shareNumerator}</td><td>${land.shareDenominator}</td><td>${shareAreaM2.toFixed(2)}</td><td>${shareAreaPing.toFixed(2)}</td><td>${sharePercentage}%</td><td>${buildingDisplay}</td></tr><tr class="subtotal-row"><td colspan="3">å°è¨ˆ</td><td>${areaM2.toFixed(2)}</td><td>${land.area.toFixed(2)}</td><td colspan="3"></td><td>${shareAreaM2.toFixed(2)}</td><td>${shareAreaPing.toFixed(2)}</td><td>${sharePercentage}%</td><td></td></tr>`;
        }
        function renderBuildingTable(land) {
            if (!land.hasBuilding) { 
                document.getElementById('buildingAddress').innerHTML = '<strong>åœ°å€: ç„¡</strong>';
                document.getElementById('buildingTableBody').innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 20px; color: #666;">æ­¤ç­†åœŸåœ°ç„¡åœ°ä¸Šç‰©</td></tr>`; return;
            }
            const buildingAreaPing = (Math.random() * 20 + 10).toFixed(2), buildingAreaM2 = (buildingAreaPing * PING_TO_M2).toFixed(2), buildingOwners = Math.floor(Math.random() * 15) + 1, buildingShareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0, buildingShareAreaM2 = (buildingAreaM2 * buildingShareRatio).toFixed(2), buildingShareAreaPing = (buildingAreaPing * buildingShareRatio).toFixed(2), buildingSharePercentage = (buildingShareRatio * 100).toFixed(2);
            const fullAddress = `${land.region}${land.district}${[ "ä¿¡ç¾©è·¯", "æ¾æ™ºè·¯", "èŠæ•¬è·¯"][Math.floor(Math.random()*3)]}${Math.floor(Math.random()*200)+1}å··${Math.floor(Math.random()*50)+1}è™Ÿ`;
            document.getElementById('buildingAddress').innerHTML = `<strong>åœ°å€:${fullAddress}</strong>`;
            document.getElementById('buildingTableBody').innerHTML = `<tr><td rowspan="2">${land.buildingId}</td><td>1</td><td rowspan="2">${buildingOwners}</td><td>${(buildingAreaM2 / 2).toFixed(2)}</td><td>${(buildingAreaPing / 2).toFixed(2)}</td><td>${land.shareNumerator}</td><td>${land.shareDenominator}</td><td>${(buildingShareAreaM2 / 2).toFixed(2)}</td><td>${(buildingShareAreaPing / 2).toFixed(2)}</td><td>${buildingSharePercentage}%</td><td rowspan="2"></td></tr><tr><td>2</td><td>${(buildingAreaM2 / 2).toFixed(2)}</td><td>${(buildingAreaPing / 2).toFixed(2)}</td><td>${land.shareNumerator}</td><td>${land.shareDenominator}</td><td>${(buildingShareAreaM2 / 2).toFixed(2)}</td><td>${(buildingShareAreaPing / 2).toFixed(2)}</td><td>${buildingSharePercentage}%</td></tr><tr class="subtotal-row"><td colspan="3">å°è¨ˆ</td><td>${buildingAreaM2}</td><td>${buildingAreaPing}</td><td colspan="2"></td><td>${buildingShareAreaM2}</td><td>${buildingShareAreaPing}</td><td>${(parseFloat(buildingSharePercentage) * 2).toFixed(2)}%</td><td></td></tr>`;
        }

        function renderRealPriceTable(land) {
            let contentHTML = '';
            
            const hardcodedData = [
                { id: 1, lat: 25.040, lng: 121.558, address: "å…‰å¾©å—è·¯2xxè™Ÿ", type: "ä½å®…ç”¨åœ°", unitPrice: 145.0, area: 45.2, note: "" },
                { id: 2, lat: 25.040, lng: 121.560, address: "ä»æ„›è·¯å››æ®µ505è™Ÿ", type: "å…¬å…±è¨­æ–½ç”¨åœ°", unitPrice: 130.0, area: 150.0, note: "ç‰¹æ®Šäº¤æ˜“" },
                { id: 3, lat: 25.037, lng: 121.564, address: "æ¾é«˜è·¯1xè™Ÿ", type: "å•†æ¥­ç”¨åœ°", unitPrice: 180.0, area: 120.5, note: "" },
                { id: 4, lat: 25.037, lng: 121.566, address: "å¿ å­æ±è·¯äº”æ®µ68è™Ÿ", type: "å•†æ¥­ç”¨åœ°", unitPrice: 210.0, area: 95.8, note: "" },
                { id: 5, lat: 25.035, lng: 121.566, address: "æ¾å£½è·¯2xè™Ÿ", type: "å•†æ¥­ç”¨åœ°", unitPrice: 148.0, area: 88.0, note: "" },
                { id: 6, lat: 25.034, lng: 121.566, address: "æ¾å£½è·¯12è™Ÿ", type: "å•†æ¥­ç”¨åœ°", unitPrice: 140.0, area: 110.3, note: "" },
                { id: 7, lat: 25.033, lng: 121.568, address: "èŠæ•¬è·¯1xxè™Ÿ", type: "ä½å®…ç”¨åœ°", unitPrice: 125.0, area: 35.6, note: "" },
                { id: 8, lat: 25.030, lng: 121.568, address: "èŠæ•¬è·¯4xxè™Ÿ", type: "ä½å®…ç”¨åœ°", unitPrice: 120.0, area: 40.1, note: "è¦ªå‹äº¤æ˜“" },
                { id: 9, lat: 25.028, lng: 121.565, address: "å³èˆˆè¡—1xxå··", type: "ä½å®…ç”¨åœ°", unitPrice: 115.0, area: 28.9, note: "" }
            ];

            window.realPriceData = hardcodedData.map(item => {
                const transactionDate = `114/${String(Math.floor(Math.random() * 5) + 1).padStart(2, '0')}`;
                const totalPrice = item.area * item.unitPrice;
                const typeRaw = item.type;
                
                return {
                    id: item.id,
                    date: transactionDate,
                    address: item.address,
                    type: typeRaw,
                    typeCategory: typeRaw.includes('ä½å®…') ? 'residential' : typeRaw.includes('å•†æ¥­') ? 'commercial' : 'industrial',
                    totalPrice: totalPrice,
                    area: item.area,
                    unitPrice: item.unitPrice,
                    note: item.note,
                    lat: item.lat,
                    lng: item.lng
                };
            });

            window.realPriceData.forEach(data => {
                contentHTML += `<tr><td class="center-align"><strong>${data.id}</strong></td><td class="center-align">${data.date}</td><td>${data.address}</td><td class="center-align">${data.type}</td><td class="center-align price-highlight">${(data.totalPrice/1000).toFixed(1)} è¬</td><td class="center-align">${data.area.toFixed(2)} åª</td><td class="center-align price-highlight">${data.unitPrice.toFixed(1)} è¬/åª</td><td class="center-align">${data.note}</td></tr>`;
            });
            
            document.getElementById('realPriceTableBody').innerHTML = contentHTML;
        }

        let realPriceMapInstance = null;
        let mapMarkers = [];
        
        function switchRealPriceView(viewType) {
            const tableView = document.getElementById('realPriceTableView');
            const mapView = document.getElementById('realPriceMapView');
            const buttons = document.querySelectorAll('.view-toggle-btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (viewType === 'table') {
                tableView.classList.add('active');
                mapView.classList.remove('active');
                buttons[0].classList.add('active');
            } else {
                tableView.classList.remove('active');
                mapView.classList.add('active');
                buttons[1].classList.add('active');
                if (!realPriceMapInstance) {
                    initRealPriceMap();
                }
            }
        }

        function initRealPriceMap() {
            realPriceMapInstance = L.map('realPriceMap').setView(currentCoords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(realPriceMapInstance);
            
            const targetIcon = L.divIcon({
                className: 'target-marker',
                html: '<div style="background: #dc2626; width: 30px; height: 30px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">ğŸ“</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            L.marker(currentCoords, { icon: targetIcon })
                .addTo(realPriceMapInstance)
                .bindPopup('<div class="custom-popup"><div class="popup-header">ğŸ“ ç›®æ¨™åœŸåœ°ä½ç½®</div></div>');
            
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (!realPriceMapInstance || !window.realPriceData) return;
            
            mapMarkers.forEach(marker => realPriceMapInstance.removeLayer(marker));
            mapMarkers = [];
            
            const showResidential = document.getElementById('filterResidential')?.checked ?? true;
            const showCommercial = document.getElementById('filterCommercial')?.checked ?? true;
            const showIndustrial = document.getElementById('filterIndustrial')?.checked ?? true;
            
            let filteredData = window.realPriceData.filter(data => {
                if (data.typeCategory === 'residential' && !showResidential) return false;
                if (data.typeCategory === 'commercial' && !showCommercial) return false;
                if (data.typeCategory === 'industrial' && !showIndustrial) return false;
                return true;
            });
            
            if (filteredData.length > 0) {
                const prices = filteredData.map(d => d.unitPrice);
                const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                const maxPrice = Math.max(...prices);
                const minPrice = Math.min(...prices);
                
                document.getElementById('mapTransactionCount').textContent = filteredData.length;
                document.getElementById('mapAvgPrice').textContent = avgPrice.toFixed(1);
                document.getElementById('mapMaxPrice').textContent = maxPrice.toFixed(1);
                document.getElementById('mapMinPrice').textContent = minPrice.toFixed(1);
            }
            
            filteredData.forEach(data => {
                let color = '#10b981'; 
                if (data.unitPrice > 200) {
                    color = '#ef4444'; 
                } else if (data.unitPrice > 150) {
                    color = '#f59e0b'; 
                }
                
                const markerIcon = L.divIcon({
                    className: 'price-marker',
                    html: `<div style="background: ${color}; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${data.id}</div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });
                
                const popupContent = `
                    <div class="custom-popup">
                        <div class="popup-header">åœ°é» ${data.id} - ${data.type}</div>
                        <div class="popup-row">
                            <span class="popup-label">äº¤æ˜“æ™‚é–“</span>
                            <span class="popup-value">${data.date}</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">åœ°å€</span>
                            <span class="popup-value">${data.address}</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">åœŸåœ°é¢ç©</span>
                            <span class="popup-value">${data.area.toFixed(2)} åª</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">ç¸½åƒ¹</span>
                            <span class="popup-value popup-price">${(data.totalPrice/1000).toFixed(1)} è¬</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">å–®åƒ¹</span>
                            <span class="popup-value popup-price">${data.unitPrice.toFixed(1)} è¬/åª</span>
                        </div>
                        ${data.note ? `<div class="popup-row"><span class="popup-label">å‚™è¨»</span><span class="popup-value">${data.note}</span></div>` : ''}
                    </div>
                `;
                
                const marker = L.marker([data.lat, data.lng], { icon: markerIcon })
                    .addTo(realPriceMapInstance)
                    .bindPopup(popupContent);
                
                mapMarkers.push(marker);
            });
        }

        function renderShareAnalysis(land) {
            const shareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0; const shareAreaPing = land.area * shareRatio; const sharePercentage = (shareRatio * 100).toFixed(2);
            document.getElementById('ownerCountDisplay').innerHTML = `${land.ownerCount} äºº`; document.getElementById('shareRatioDisplay').innerHTML = `${land.shareNumerator}/${land.shareDenominator} (${sharePercentage}%)`; document.getElementById('shareAreaDisplay').innerHTML = `${shareAreaPing.toFixed(2)} åª`;
            let ownershipType = (land.ownerCount === 1) ? '<span style="color: #059669;">å–®ç¨æ‰€æœ‰</span>' : (land.ownerCount <= 3) ? '<span style="color: #f59e0b;">åˆ†åˆ¥å…±æœ‰ (å°‘æ•¸)</span>' : (land.ownerCount <= 10) ? '<span style="color: #f59e0b;">åˆ†åˆ¥å…±æœ‰ (ä¸­ç­‰)</span>' : '<span style="color: #dc2626;">åˆ†åˆ¥å…±æœ‰ (å¤šæ•¸)</span>';
            document.getElementById('ownershipTypeDisplay').innerHTML = ownershipType;
            renderOwnershipChart(land);
            const shareUnitPrice = land.pricePerPing; const fullPrice = land.marketPrice; const priceDiff = ((shareUnitPrice / fullPrice - 1) * 100).toFixed(1); const totalInvestment = shareAreaPing * shareUnitPrice;
            document.getElementById('shareUnitPriceDisplay').innerHTML = `${shareUnitPrice.toFixed(1)} è¬/åª`; document.getElementById('fullPriceDisplay').innerHTML = `${fullPrice.toFixed(1)} è¬/åª`;
            if (priceDiff < 0) { document.getElementById('priceDiffDisplay').innerHTML = `æŠ˜åƒ¹ ${Math.abs(priceDiff)}% <span style="color: #059669;">âœ“ åˆ’ç®—</span>`; document.getElementById('priceDiffDisplay').className = 'info-value good'; } else { document.getElementById('priceDiffDisplay').innerHTML = `æº¢åƒ¹ ${priceDiff}% <span style="color: #dc2626;">âš ï¸ åé«˜</span>`; document.getElementById('priceDiffDisplay').className = 'info-value bad'; }
            document.getElementById('totalInvestmentDisplay').innerHTML = `${(totalInvestment).toFixed(1)} è¬`;
            let investmentAdvice = (priceDiff < -20) ? `æŒåˆ†åƒ¹æ ¼è¼ƒå¸‚å ´è¡Œæƒ…<strong style="color: #059669;">ä½ ${Math.abs(priceDiff)}%</strong>ï¼Œå…·æœ‰æŠ•è³‡åƒ¹å€¼ã€‚å»ºè­°ç©æ¥µè©•ä¼°ã€‚` : (priceDiff < -10) ? `æŒåˆ†åƒ¹æ ¼<strong style="color: #059669;">åˆç†åä½</strong>ï¼Œè‹¥æ•´åˆæˆåŠŸå¯ç²åˆ©ã€‚` : (priceDiff < 10) ? `æŒåˆ†åƒ¹æ ¼<strong style="color: #f59e0b;">æ¥è¿‘å¸‚å ´è¡Œæƒ…</strong>ï¼Œéœ€å¯©æ…è©•ä¼°æ•´åˆæˆæœ¬ã€‚` : `æŒåˆ†åƒ¹æ ¼<strong style="color: #dc2626;">åé«˜</strong>ï¼Œå»ºè­°é‡æ–°è­°åƒ¹æˆ–è©•ä¼°å…¶ä»–æ¨™çš„ã€‚`;
            document.getElementById('investmentAdvice').innerHTML = investmentAdvice;
            let difficulty, riskLevel, riskColor, riskWidth, integrationTime, successRate;
            if (land.ownerCount === 1) { difficulty = '<span style="color: #059669;">ç„¡éœ€æ•´åˆ</span>'; riskLevel = 'ä½é¢¨éšª'; riskColor = 'low'; riskWidth = '20%'; integrationTime = 'ç«‹å³å¯ç”¨'; successRate = '<span style="color: #059669;">100%</span>'; } else if (land.ownerCount <= 3) { difficulty = '<span style="color: #059669;">å®¹æ˜“</span>'; riskLevel = 'ä½é¢¨éšª'; riskColor = 'low'; riskWidth = '30%'; integrationTime = '3-6 å€‹æœˆ'; successRate = '<span style="color: #059669;">80-90%</span>'; } else if (land.ownerCount <= 10) { difficulty = '<span style="color: #f59e0b;">ä¸­ç­‰</span>'; riskLevel = 'ä¸­é¢¨éšª'; riskColor = 'medium'; riskWidth = '60%'; integrationTime = '6-18 å€‹æœˆ'; successRate = '<span style="color: #f59e0b;">50-70%</span>'; } else { difficulty = '<span style="color: #dc2626;">å›°é›£</span>'; riskLevel = 'é«˜é¢¨éšª'; riskColor = 'high'; riskWidth = '90%'; integrationTime = '1.5-5 å¹´ä»¥ä¸Š'; successRate = '<span style="color: #dc2626;">20-40%</span>'; }
            document.getElementById('integrationDifficulty').innerHTML = difficulty; document.getElementById('riskLevel').textContent = riskLevel; document.getElementById('riskFill').className = `risk-meter-fill ${riskColor}`; document.getElementById('riskFill').style.width = riskWidth; document.getElementById('integrationTime').innerHTML = integrationTime; document.getElementById('successRate').innerHTML = successRate;
            renderIntegrationStrategy(land);
        }
        function renderOwnershipChart(land) {
            const bar = document.getElementById('ownershipBar'); const legend = document.getElementById('ownershipLegend'); const shareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0; const yourShare = shareRatio * 100; const othersShare = 100 - yourShare;
            bar.innerHTML = `<div class="ownership-segment" style="width: ${yourShare}%; background: #10b981;">æ‚¨ ${yourShare.toFixed(1)}%</div><div class="ownership-segment" style="width: ${othersShare}%; background: #94a3b8;">å…¶ä»– ${land.ownerCount - 1} äºº ${othersShare.toFixed(1)}%</div>`;
            legend.innerHTML = `<div class="legend-item"><div class="legend-color" style="background: #10b981;"></div><span>æ‚¨çš„æŒåˆ† (${land.shareNumerator}/${land.shareDenominator})</span></div><div class="legend-item"><div class="legend-color" style="background: #94a3b8;"></div><span>å…¶ä»–å…±æœ‰äºº (${land.ownerCount - 1} äºº)</span></div>`;
        }
        function renderIntegrationStrategy(land) {
            const container = document.getElementById('integrationStrategy'); let strategies = (land.ownerCount === 1) ? ['ç”¢æ¬Šå®Œæ•´ï¼Œç„¡éœ€æ•´åˆ', 'å¯ç«‹å³é€²è¡Œé–‹ç™¼è¦åŠƒ'] : (land.ownerCount <= 3) ? ['é€ä¸€æ‹œè¨ªå…¶ä»–å…±æœ‰äººäº†è§£æ„é¡˜', 'å¯è€ƒæ…®å…¨éƒ¨æ”¶è³¼æˆ–å”è­°é–‹ç™¼', 'é ç•™3-6å€‹æœˆæ•´åˆæ™‚é–“'] : (land.ownerCount <= 10) ? ['å…ˆæ‰¾å‡ºä¸»è¦æŒåˆ†è€…é€²è¡Œæºé€š', 'è©•ä¼°æ˜¯å¦æœ‰äººå·²åœ¨æ”¶è³¼æŒåˆ†', 'å¿…è¦æ™‚å¯è¡Œä½¿åˆ†å‰²è«‹æ±‚æ¬Š'] : ['âš ï¸ æ•´åˆé›£åº¦æ¥µé«˜ï¼Œéœ€è¬¹æ…è©•ä¼°', 'å»ºè­°å…ˆèª¿æŸ¥æ˜¯å¦æœ‰å¤§è‚¡æ±', 'è©•ä¼°è¨´è¨Ÿåˆ†å‰²çš„å¯è¡Œæ€§', 'å¯è€ƒæ…®åƒ…æ”¶è³¼è‡ªå·±éœ€è¦çš„æŒåˆ†'];
            let html = '<h5>ğŸ¯ æ•´åˆç­–ç•¥å»ºè­°</h5><ul>'; strategies.forEach(strategy => { html += `<li>${strategy}</li>`; }); html += '</ul>'; container.innerHTML = html;
        }
        function renderExpertAdvice(land) {
            const adviceContainer = document.getElementById('expertAdviceContent'); let strengths = '', risks = '', recommendation = ''; const priceDiff = land.pricePerPing - land.marketPrice, priceDiffPercent = (priceDiff / land.marketPrice) * 100;
            if (priceDiff < 0) { strengths += `<li><strong>åƒ¹æ ¼å„ªå‹¢:</strong>ç›®å‰é–‹åƒ¹å–®åƒ¹ç‚º <span class="highlight-good">${land.pricePerPing} è¬/åª</span>,ä½æ–¼é„°è¿‘å¯¦åƒ¹ç™»éŒ„å¹³å‡ <span class="highlight-good">${Math.abs(priceDiffPercent).toFixed(1)}%</span>ã€‚</li>`; } else { risks += `<li><strong>åƒ¹æ ¼åé«˜:</strong>ç›®å‰é–‹åƒ¹å–®åƒ¹ç‚º <span class="highlight-bad">${land.pricePerPing} è¬/åª</span>,é«˜æ–¼é„°è¿‘å¯¦åƒ¹ç™»éŒ„å¹³å‡ <span class="highlight-bad">${priceDiffPercent.toFixed(1)}%</span>ã€‚</li>`; }
            if (land.landUseZone.includes('å•†') || land.landUseZone.includes('ä½')) { strengths += `<li><strong>åˆ†å€æ½›åŠ›:</strong>åœŸåœ°ä½¿ç”¨åˆ†å€ç‚º <span class="highlight-good">${land.landUseZone}</span>,å•†æ¥­æˆ–ä½å®…åƒ¹å€¼é«˜ã€‚</li>`; } else { strengths += `<li><strong>åˆ†å€é¡å‹:</strong>åœŸåœ°ä½¿ç”¨åˆ†å€ç‚º ${land.landUseZone},éœ€è©•ä¼°å…¶é–‹ç™¼æ½›åŠ›ã€‚</li>`; }
            if (land.ownerCount > 10) { risks += `<li><strong>ç”¢æ¬Šè¤‡é›œ:</strong>æ‰€æœ‰æ¬Šäººæ•¸é«˜é” <span class="highlight-bad">${land.ownerCount}äºº</span>,æ•´åˆé–‹ç™¼<span class="highlight-bad">é›£åº¦æ¥µé«˜</span>ã€‚</li>`; } else if (land.ownerCount > 1) { risks += `<li><strong>ç”¢æ¬ŠæŒåˆ†:</strong>æ‰€æœ‰æ¬Šäººæ•¸ç‚º <span class="highlight-bad">${land.ownerCount}äºº</span>,æ•´åˆé›£åº¦ä¸­ç­‰ã€‚</li>`; } else { strengths += `<li><strong>ç”¢æ¬Šå–®ç´”:</strong>æ‰€æœ‰æ¬Šäººæ•¸ç‚º 1 äºº,<span class="highlight-good">ç”¢æ¬Šå®Œæ•´</span>ã€‚</li>`; }
            if (land.hasBuilding) { risks += `<li><strong>åœ°ä¸Šç‰©è™•ç†:</strong>åœŸåœ°ä¸Š<span class="highlight-bad">å­˜æœ‰åœ°ä¸Šç‰©(å»ºè™Ÿ ${land.buildingId})</span>,éœ€è€ƒé‡å¾ŒçºŒæ‹†é·è£œå„Ÿæˆæœ¬ã€‚</li>`; }
            recommendation += `<p>ç¶œåˆè©•ä¼°,æ­¤æ¨™çš„å…·å‚™å„ªå‹¢,ä½†åŒæ™‚ä¹Ÿéœ€ç•™æ„é¢¨éšªã€‚</p>`;
            if (land.ownerCount > 10) { recommendation += `<p><strong>ä¸»è¦å»ºè­°:</strong>æ­¤æ¡ˆæœ€å¤§æŒ‘æˆ°åœ¨æ–¼<span class="highlight-bad">é«˜äººæ•¸çš„ç”¢æ¬Šæ•´åˆ</span>ã€‚å»ºè­°æŠ•è³‡äººè‹¥ç„¡è±å¯Œæ•´åˆç¶“é©—,æ‡‰è¬¹æ…è©•ä¼°ã€‚</p>`; } else { recommendation += `<p><strong>ä¸»è¦å»ºè­°:</strong>æ­¤æ¡ˆç”¢æ¬Šç›¸å°å–®ç´”,ä¸»è¦è€ƒé‡é»åœ¨æ–¼åƒ¹æ ¼èˆ‡åœ°ä¸Šç‰©ã€‚å»ºè­°è²·æ–¹å¯ç©æ¥µå‡ºåƒ¹,ä¸¦å°‡åœ°ä¸Šç‰©è™•ç†æˆæœ¬ç´å…¥ç¸½æŠ•è³‡é ç®—ä¸­ã€‚</p>`; }
            adviceContainer.innerHTML = `<h3>ä¸€ã€å„ªå‹¢åˆ†æ</h3><ul>${strengths || "<li>å°šç„¡é¡¯è‘—å„ªå‹¢</li>"}</ul><h3>äºŒã€é¢¨éšªè©•ä¼°</h3><ul>${risks || "<li>å°šç„¡é¡¯è‘—é¢¨éšª</li>"}</ul><h3>ä¸‰ã€ç¶œåˆå»ºè­°èˆ‡ç­–ç•¥</h3>${recommendation}`;
        }
        function initializeMaps(land) {
            const coords = currentCoords;
            const zoningMap = L.map('zoningMap').setView(coords, 16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(zoningMap); L.polygon([[coords[0] + 0.001, coords[1] - 0.001], [coords[0] + 0.001, coords[1] + 0.001], [coords[0] - 0.001, coords[1] + 0.001], [coords[0] - 0.001, coords[1] - 0.001]], { color: '#DC2626', fillColor: '#ffcdd2', fillOpacity: 0.5 }).addTo(zoningMap).bindPopup(`ä½¿ç”¨åˆ†å€:${land.landUseZone}<br>é¢ç©:${land.area}åª`);
            const cadastralMap = L.map('cadastralMap').setView(coords, 17); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(cadastralMap); L.marker(coords).addTo(cadastralMap).bindPopup(`åœ°è™Ÿ:${land.id}<br>${land.title}`); L.polygon([[coords[0] + 0.0008, coords[1] - 0.0008], [coords[0] + 0.0008, coords[1] + 0.0008], [coords[0] - 0.0008, coords[1] + 0.0008], [coords[0] - 0.0008, coords[1] - 0.0008]], { color: '#2563eb', weight: 2, fillOpacity: 0.1 }).addTo(cadastralMap);
            const topographicMap = L.map('topographicMap').setView(coords, 15); L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png').addTo(topographicMap); L.marker(coords).addTo(topographicMap).bindPopup(`åœ°å½¢ä½ç½®<br>${land.region}${land.district}`);
            const aerialMap = L.map('aerialMap').setView(coords, 18); L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(aerialMap); L.circle(coords, { color: '#059669', fillColor: '#10b981', fillOpacity: 0.3, radius: 50 }).addTo(aerialMap).bindPopup('åœŸåœ°ä½ç½®');
            const overlayMap = L.map('overlayMap').setView(coords, 16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(overlayMap); L.polygon([[coords[0] + 0.001, coords[1] - 0.001], [coords[0] + 0.001, coords[1] + 0.001], [coords[0] - 0.001, coords[1] + 0.001], [coords[0] - 0.001, coords[1] - 0.001]], { color: '#DC2626', fillColor: '#ffcdd2', fillOpacity: 0.4 }).addTo(overlayMap); L.polygon([[coords[0] + 0.0008, coords[1] - 0.0008], [coords[0] + 0.0008, coords[1] + 0.0008], [coords[0] - 0.0008, coords[1] + 0.0008], [coords[0] - 0.0008, coords[1] - 0.0008]], { color: '#2563eb', weight: 2, fillOpacity: 0 }).addTo(overlayMap); L.marker(coords).addTo(overlayMap).bindPopup('å¤šåœ–å±¤å¥—åœ–é è¦½ã€‚<br>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å•Ÿå…¨åŠŸèƒ½åˆ†æã€‚').openPopup();
        }
        
        // MODIFICATION START: Added amenities map function
        function initializeAmenitiesMap() {
            const coords = currentCoords;
            const amenitiesMap = L.map('amenitiesMap').setView(coords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(amenitiesMap);

            const amenitiesData = [
                { name: 'æ·é‹å¸‚æ”¿åºœç«™', type: 'transport', lat: 25.0408, lng: 121.5645, icon: 'ğŸš‡', color: '#0288d1' },
                { name: 'æ·é‹å°åŒ—101/ä¸–è²¿ç«™', type: 'transport', lat: 25.0339, lng: 121.5645, icon: 'ğŸš‡', color: '#0288d1' },
                { name: 'å¸‚åºœè½‰é‹ç«™', type: 'transport', lat: 25.0403, lng: 121.5652, icon: 'ğŸšŒ', color: '#0288d1' },
                { name: 'è‡ºåŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©åœ‹æ°‘å°å­¸', type: 'school', lat: 25.0359, lng: 121.5701, icon: 'ğŸ«', color: '#f57c00' },
                { name: 'è‡ºåŒ—å¸‚ç«‹ä¿¡ç¾©åœ‹æ°‘ä¸­å­¸', type: 'school', lat: 25.0318, lng: 121.5698, icon: 'ğŸ«', color: '#f57c00' },
                { name: 'åšæ„›åœ‹å°', type: 'school', lat: 25.0375, lng: 121.5714, icon: 'ğŸ«', color: '#f57c00' },
                { name: 'ä¿¡ç¾©å»£å ´ (ä¸­å¼·å…¬åœ’)', type: 'park', lat: 25.0315, lng: 121.5665, icon: 'ğŸŒ³', color: '#388e3c' },
                { name: 'åœ‹çˆ¶ç´€å¿µé¤¨', type: 'park', lat: 25.0405, lng: 121.5592, icon: 'ğŸŒ³', color: '#388e3c' },
                { name: 'æ–°å…‰ä¸‰è¶Š å°åŒ—ä¿¡ç¾©æ–°å¤©åœ°', type: 'shopping', lat: 25.0373, lng: 121.5663, icon: 'ğŸ›ï¸', color: '#d32f2f' },
                { name: 'å°åŒ—101è³¼ç‰©ä¸­å¿ƒ', type: 'shopping', lat: 25.0336, lng: 121.5647, icon: 'ğŸ›ï¸', color: '#d32f2f' },
                { name: 'å¾®é¢¨ä¿¡ç¾©', type: 'shopping', lat: 25.0390, lng: 121.5660, icon: 'ğŸ›ï¸', color: '#d32f2f' },
                { name: 'è‡ºåŒ—é†«å­¸å¤§å­¸é™„è¨­é†«é™¢', type: 'medical', lat: 25.0261, lng: 121.5617, icon: 'ğŸ¥', color: '#7b1fa2' },
                { name: 'ä¿¡ç¾©é‹å‹•ä¸­å¿ƒ', type: 'medical', lat: 25.0321, lng: 121.5715, icon: 'ğŸ’ª', color: '#7b1fa2' }
            ];

            const targetIcon = L.divIcon({
                className: 'target-marker',
                html: '<div style="background: #dc2626; width: 30px; height: 30px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">ğŸ“</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            L.marker(coords, { icon: targetIcon, zIndexOffset: 1000 })
                .addTo(amenitiesMap)
                .bindPopup('<div class="custom-popup"><div class="popup-header">ğŸ“ ç›®æ¨™åœŸåœ°ä½ç½®</div></div>');

            const layers = {
                transport: L.layerGroup(),
                school: L.layerGroup(),
                park: L.layerGroup(),
                shopping: L.layerGroup(),
                medical: L.layerGroup()
            };

            amenitiesData.forEach(amenity => {
                if (!layers[amenity.type]) return;

                const amenityIcon = L.divIcon({
                    className: 'amenity-marker',
                    html: `<div style="background-color:${amenity.color};" class="amenity-marker">${amenity.icon}</div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                L.marker([amenity.lat, amenity.lng], { icon: amenityIcon })
                    .bindPopup(amenity.name)
                    .addTo(layers[amenity.type]);
            });

            document.querySelectorAll('.amenities-controls input[type="checkbox"]:checked').forEach(checkbox => {
                const layerName = checkbox.dataset.layer;
                if (layers[layerName]) {
                    layers[layerName].addTo(amenitiesMap);
                }
            });

            document.querySelectorAll('.amenities-controls input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const layerName = e.target.dataset.layer;
                    if (layers[layerName]) {
                        if (e.target.checked) {
                            amenitiesMap.addLayer(layers[layerName]);
                        } else {
                            amenitiesMap.removeLayer(layers[layerName]);
                        }
                    }
                });
            });
        }
        // MODIFICATION END

        function initializeStreetView(land) {
            const coords = currentCoords;
            const streetviewMap = L.map('streetviewContainer').setView(coords, 18); L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(streetviewMap);
            const marker = L.marker(coords).addTo(streetviewMap); const streetviewUrl = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${coords[0]},${coords[1]}`;
            marker.bindPopup(`<div style="text-align: center;"><strong>${land.title}</strong><br><a href="${streetviewUrl}" target="_blank" style="display:inline-block;margin-top:10px;padding:8px 16px;background:linear-gradient(135deg, #4285f4 0%, #34a853 100%);color:white;text-decoration:none;border-radius:6px;font-weight:600;">ğŸŒ é–‹å•Ÿ Google è¡—æ™¯</a></div>`).openPopup();
            L.circle(coords, { color: '#4285f4', fillColor: '#4285f4', fillOpacity: 0.2, radius: 30 }).addTo(streetviewMap);
        }
        function openExternalMap(mapType) { let url = `https://www.openstreetmap.org/#map=17/${currentCoords[0]}/${currentCoords[1]}`; if (mapType === 'aerial') { url = `https://www.google.com/maps/@${currentCoords[0]},${currentCoords[1]},18z/data=!3m1!1e3`; } window.open(url, '_blank'); }
    </script>
</body>
</html>