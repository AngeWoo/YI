<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產調分析表 - 一如土地交易競價看板</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        /* --- 全局與字體設定 --- */
        :root {
            --primary-color: #DC2626;
            --secondary-color: #059669;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-light: #f7f9fc;
            --bg-white: #ffffff;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f1f5f9;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23d1dce9' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v18.5l-13 7.5L0 33.5V15z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- 頂部橫幅設計 (MODIFIED) --- */
        .header {
            background: linear-gradient(to right, #fff5f5, #ffdddd);
            color: var(--text-dark); /* Changed for readability */
            padding: 30px 5%;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-bottom: 4px solid var(--primary-color);
        }
        
        .title-container {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .logo {
            width: 60px;
            height: auto;
        }

        .header h1 {
            font-size: 2.5rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            margin: 0;
            color: var(--primary-color); /* Set title color */
        }

        .back-button {
            display: inline-block;
            padding: 12px 25px;
            background: var(--secondary-color);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid transparent;
        }

        .back-button:hover {
            transform: translateY(-3px);
            background: #06c284;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
        }

        /* --- 全寬內容區塊 --- */
        .analysis-section {
            background: var(--bg-white);
            margin: 20px auto;
            padding: 30px 5%; /* Responsive padding */
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .analysis-section:nth-of-type(even) {
            background: var(--bg-light);
        }

        .section-title {
            font-size: 1.8rem;
            color: var(--text-dark);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* --- 通用元件樣式 --- */
        .property-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 12px 18px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-light);
        }

        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            background: var(--bg-white);
            border-radius: 8px;
            overflow: hidden;
        }

        .analysis-table th, .analysis-table td {
            border: 1px solid var(--border-color);
            padding: 12px 10px;
            text-align: center;
            vertical-align: middle;
        }

        .analysis-table th {
            background-color: #f1f5f9;
            font-weight: 600;
        }
        
        .analysis-table .sub-header {
            background-color: #f8fafc;
            font-size: 12px;
        }

        .analysis-table .zone-cell {
            background-color: #fee2e2;
            color: #b91c1c;
            font-weight: bold;
        }
        
        .analysis-table .subtotal-row td {
            background-color: #fefce8;
            font-weight: bold;
        }

        .gis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        .streetview-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            background: var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .gis-card {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .gis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .gis-card h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .open-map-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .open-map-btn.overlay-btn {
             background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        .open-map-btn:hover {
            filter: brightness(1.1);
        }
        
        .real-price-table th {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .amenities-section .map-container,
        .streetview-section .streetview-container {
             margin-top: 20px;
        }
        
        .share-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }
        
        .share-info-card {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.07);
            border-top: 4px solid var(--secondary-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .share-info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .advice-content {
            background: #fffbeb;
            border-left: 5px solid #f59e0b;
            border-radius: 8px;
            padding: 25px;
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-dark);
        }
        
        .external-links {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .external-link-btn {
            padding: 8px 20px;
            background: #f8f9fa;
            color: #2563eb;
            text-decoration: none;
            border-radius: 6px;
            border: 2px solid #e5e7eb;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .external-link-btn:hover {
            color: #1d4ed8;
            background: #eff6ff;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
        }

        .main-footer {
            background-color: #f5f5f5;
            color: #333333;
            padding: 50px 5% 30px;
            border-top: 3px solid var(--primary-color);
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-section {
            flex: 1;
            min-width: 200px;
        }

        .footer-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--primary-color);
            width: 100%;
        }

        .footer-links {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-links li {
            margin-bottom: 12px;
        }

        .footer-links a {
            color: #555555;
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--primary-color);
        }

        .footer-contact {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-contact li {
            margin-bottom: 14px;
            color: #555555;
            font-size: 0.95rem;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .footer-contact .contact-icon {
            margin-top: 2px;
            color: var(--primary-color);
        }

        .footer-contact a {
            color: #555555;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-contact a:hover {
            color: var(--primary-color);
        }

        .footer-external-links {
            max-width: 1200px;
            margin: 0 auto 40px;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }

        .footer-external-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #dddddd;
            color: #666666;
            font-size: 0.9rem;
        }

        /* --- 響應式調整 --- */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .analysis-section { padding: 20px; }
            .section-title { font-size: 1.5rem; }
            .gis-grid, .share-info-grid { grid-template-columns: 1fr; }
            .analysis-table { font-size: 12px; }
            .analysis-table th, .analysis-table td { padding: 8px 5px; }
            .streetview-container, .map-container { height: 350px; }
            
            .external-links { gap: 8px; }
            .external-link-btn { padding: 6px 14px; font-size: 0.8rem; }
            .main-footer { padding: 40px 20px 20px; }
            .footer-content { flex-direction: column; gap: 30px; }
            .footer-section { min-width: 100%; }
        }
        
        /* Leaflet 地圖相關樣式 */
        .map-container { height: 400px; border-radius: 8px; overflow: hidden; background: #e2e8f0; }
        .amenities-controls { display: flex; flex-wrap: wrap; gap: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .amenities-controls label { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #334155; cursor: pointer; user-select: none; }
        .amenities-controls input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-color); }
        .amenity-marker { display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 16px; font-weight: bold; width: 32px !important; height: 32px !important; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .custom-popup .popup-header { background: var(--primary-color); }
        .map-controls, .map-stats, .view-toggle-buttons, .real-price-header { margin-bottom: 20px; }
        .view-toggle-buttons { display: flex; gap: 10px; background: white; padding: 4px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .view-toggle-btn { padding: 10px 20px; border: none; background: transparent; color: #64748b; font-weight: 600; font-size: 14px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
        .view-toggle-btn.active { background: var(--primary-color); color: white; }
        .real-price-view { display: none; }
        .real-price-view.active { display: block; }
        .map-controls { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .price-legend { display: flex; align-items: center; gap: 15px; }
        .legend-title { font-weight: 600; color: #1e293b; font-size: 14px; }
        .legend-items, .legend-item { display: flex; align-items: center; gap: 10px; }
        .legend-marker { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3); }
        .filter-controls { display: flex; gap: 20px; }
        .filter-controls label { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #475569; cursor: pointer; user-select: none; }
        .filter-controls input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .map-stats { background: white; padding: 20px; border-radius: 12px; margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-item { text-align: center; padding: 15px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 8px; }
        .stat-label { display: block; font-size: 13px; color: #64748b; margin-bottom: 8px; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--primary-color); }
        .stat-unit { font-size: 14px; color: #64748b; margin-left: 4px; }
        .custom-popup { min-width: 250px; }
        .custom-popup .popup-header { color: white; padding: 12px 15px; margin: -15px -15px 12px -15px; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 14px; }
        .custom-popup .popup-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .custom-popup .popup-row:last-child { border-bottom: none; }
        .custom-popup .popup-label { color: #64748b; }
        .custom-popup .popup-value { font-weight: 600; color: #1e293b; }
        .custom-popup .popup-price { color: var(--primary-color); font-size: 16px; }
        .risk-meter { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .risk-meter-bar { flex: 1; height: 8px; background: #e0f2f1; border-radius: 4px; overflow: hidden; }
        .risk-meter-fill { height: 100%; border-radius: 4px; }
        .risk-meter-fill.low { background: linear-gradient(90deg, #10b981, #059669); }
        .risk-meter-fill.medium { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .risk-meter-fill.high { background: linear-gradient(90deg, #ef4444, #dc2626); }
    </style>
</head>
<body>
    <header class="header">
        <div class="title-container">
            <img src="logo.png" alt="一如 YIRU Logo" class="logo">
            <h1>一如永續產調分析表 (會員進階版)</h1>
        </div>
        <a href="index.html" class="back-button">← 返回競價看板</a>
    </header>

    <main>
        <section class="analysis-section land-section">
            <h2 class="section-title">📜 土地部份</h2>
            <div class="property-info"><span><strong>土地標的</strong></span><span id="landAddress" style="max-width: 70%;"><strong>地段: 載入中...</strong></span></div>
            <table class="analysis-table">
                <thead>
                    <tr><th rowspan="2">地號</th><th rowspan="2">土地<br>分區</th><th>公告現值 (114年)</th><th colspan="2">面積</th><th rowspan="2">所有權<br>人數</th><th colspan="2">土地持分</th><th colspan="3">伊土地持分面積</th><th colspan="1">有無地上物</th></tr>
                    <tr class="sub-header"><th>元/m²</th><th>m²</th><th>坪</th><th>分子</th><th>分母</th><th>m²</th><th>坪</th><th>比例</th><th>地上物建號</th></tr>
                </thead>
                <tbody id="landTableBody"></tbody>
            </table>
        </section>

        <section class="analysis-section building-section">
            <h2 class="section-title">🏗️ 地上物部份</h2>
            <div class="property-info"><span><strong>地上物地址</strong></span><span id="buildingAddress"><strong>地址: 載入中...</strong></span></div>
            <table class="analysis-table">
                <thead>
                    <tr><th rowspan="2">建號</th><th rowspan="2">所含樓<br>層</th><th rowspan="2">建物所有權<br>人數</th><th colspan="2">建物面積</th><th colspan="2">建物持分</th><th colspan="3">建物持分面積</th><th rowspan="2">備註</th></tr>
                    <tr class="sub-header"><th>m²</th><th>坪</th><th>分子</th><th>分母</th><th>m²</th><th>坪</th><th>比例</th></tr>
                </thead>
                <tbody id="buildingTableBody"></tbody>
            </table>
        </section>

        <section class="analysis-section gis-section">
            <h2 class="section-title">🗺️ GIS 圖資展示</h2>
            <div class="gis-grid">
                <div class="gis-card"><h3><span>土地使用分區圖</span><button class="open-map-btn" onclick="openExternalMap('zoning')">放大地圖</button></h3><div class="map-container" id="zoningMap"></div></div>
                <div class="gis-card"><h3><span>地籍圖</span><button class="open-map-btn" onclick="openExternalMap('cadastral')">放大地圖</button></h3><div class="map-container" id="cadastralMap"></div></div>
                <div class="gis-card"><h3><span>地形圖</span><button class="open-map-btn" onclick="openExternalMap('topographic')">放大地圖</button></h3><div class="map-container" id="topographicMap"></div></div>
                <div class="gis-card"><h3><span>航照圖</span><button class="open-map-btn" onclick="openExternalMap('aerial')">放大地圖</button></h3><div class="map-container" id="aerialMap"></div></div>
            </div>
        </section>

        <section class="analysis-section amenities-section">
            <h2 class="section-title">🛍️ 鄰近生活機能圖</h2>
            <div class="amenities-controls">
                <label><input type="checkbox" data-layer="transport" checked> 🚇 交通</label>
                <label><input type="checkbox" data-layer="school" checked> 🏫 學校</label>
                <label><input type="checkbox" data-layer="park" checked> 🌳 公園</label>
                <label><input type="checkbox" data-layer="shopping" checked> 🛒 購物</label>
                <label><input type="checkbox" data-layer="medical" checked> 🏥 醫療</label>
            </div>
            <div class="map-container" id="amenitiesMap" style="height: 500px;"></div>
        </section>

        <section class="analysis-section streetview-section">
            <h2 class="section-title">📸 Google 街景圖</h2>
            <div class="streetview-container" id="streetviewContainer"></div>
        </section>
        
        <section class="analysis-section real-price-section">
            <h2 class="section-title">💰 鄰近實價登錄資訊</h2>
             <div class="real-price-header" style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px;">
                <div class="view-toggle-buttons">
                    <button class="view-toggle-btn active" onclick="switchRealPriceView('table')">📊 表格檢視</button>
                    <button class="view-toggle-btn" onclick="switchRealPriceView('map')">🗺️ 地圖檢視</button>
                </div>
            </div>
            <div id="realPriceTableView" class="real-price-view active">
                <table class="analysis-table real-price-table">
                    <thead><tr><th>編號</th><th>交易時間</th><th>地址/地段</th><th>型態</th><th>總價</th><th>土地坪數</th><th>單價</th><th>備註</th></tr></thead>
                    <tbody id="realPriceTableBody"></tbody>
                </table>
            </div>
            <div id="realPriceMapView" class="real-price-view">
                <div class="map-controls">
                     <div class="price-legend">
                        <div class="legend-title">單價 (萬/坪)</div>
                        <div class="legend-items">
                            <div class="legend-item"><span class="legend-marker" style="background: #10b981;"></span><span>150以下</span></div>
                            <div class="legend-item"><span class="legend-marker" style="background: #f59e0b;"></span><span>150-200</span></div>
                            <div class="legend-item"><span class="legend-marker" style="background: #ef4444;"></span><span>200以上</span></div>
                        </div>
                    </div>
                     <div class="filter-controls">
                        <label><input type="checkbox" id="filterResidential" checked onchange="updateMapMarkers()"> 住宅</label>
                        <label><input type="checkbox" id="filterCommercial" checked onchange="updateMapMarkers()"> 商業</label>
                        <label><input type="checkbox" id="filterIndustrial" checked onchange="updateMapMarkers()"> 工業</label>
                    </div>
                </div>
                <div class="map-container" id="realPriceMap" style="height: 600px; border-radius: 12px;"></div>
                <div class="map-stats">
                    <div class="stat-item"><span class="stat-label">顯示交易數</span><span class="stat-value" id="mapTransactionCount">0</span></div>
                    <div class="stat-item"><span class="stat-label">平均單價</span><span class="stat-value" id="mapAvgPrice">0</span><span class="stat-unit">萬/坪</span></div>
                    <div class="stat-item"><span class="stat-label">最高單價</span><span class="stat-value" id="mapMaxPrice">0</span><span class="stat-unit">萬/坪</span></div>
                    <div class="stat-item"><span class="stat-label">最低單價</span><span class="stat-value" id="mapMinPrice">0</span><span class="stat-unit">萬/坪</span></div>
                </div>
            </div>
        </section>

        <section class="analysis-section share-analysis-section">
            <h2 class="section-title">🔍 持分地深度分析</h2>
            <div class="share-info-grid">
                 <div class="share-info-card"><h4>📊 產權結構分析</h4></div>
                <div class="share-info-card"><h4>⚖️ 法律權利說明</h4></div>
                <div class="share-info-card"><h4>💰 投資價值評估</h4></div>
                <div class="share-info-card"><h4>⚠️ 風險與整合評估</h4></div>
            </div>
        </section>

        <section class="analysis-section expert-advice-section">
            <h2 class="section-title">💡 專家建議</h2>
            <div class="advice-content" id="expertAdviceContent"></div>
        </section>
        
        <section class="analysis-section">
            <h2 class="section-title">🧩 所有圖資套圖</h2>
            <div class="gis-card">
                <h3><span>多圖層套疊預覽</span><a href="index6.html" target="_blank" class="open-map-btn overlay-btn">🚀 開啟全功能套圖分析</a></h3>
                <div class="map-container" id="overlayMap" style="height: 500px;"></div>
            </div>
        </section>
    </main>
    
    <footer class="main-footer">
        <div class="footer-external-links">
            <h3 class="footer-external-title">合作平台</h3>
            <div class="external-links">
                <a href="https://land.591.com.tw/list?type=2&region=23&kind=11" target="_blank" class="external-link-btn">591土地 ↗</a>
                <a href="https://www.yes319.com/memberlogin/?r=1017" target="_blank" class="external-link-btn">yes319 ↗</a>
                <a href="https://commercial.rakuya.com.tw/land/buy?city=0&history=1" target="_blank" class="external-link-btn">樂屋網 ↗</a>
            </div>
        </div>
        
        <div class="footer-content">
            <div class="footer-section">
                <h3 class="footer-title">關於我們</h3>
                <ul class="footer-links">
                    <li><a href="#">公司簡介</a></li>
                    <li><a href="#">專業團隊</a></li>
                    <li><a href="#">組織架構</a></li>
                    <li><a href="#">最新消息</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3 class="footer-title">服務項目</h3>
                <ul class="footer-links">
                    <li><a href="#">土地開發</a></li>
                    <li><a href="#">都市更新</a></li>
                    <li><a href="#">不動產顧問</a></li>
                    <li><a href="#">案例分享</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3 class="footer-title">聯絡資訊</h3>
                <ul class="footer-contact">
                    <li>
                        <span class="contact-icon">📞</span>
                        <a href="tel:+886227111232">02-2711-1232</a>
                    </li>
                    <li>
                        <span class="contact-icon">📧</span>
                        <a href="mailto:yirupr@yiru.com.tw">yirupr@yiru.com.tw</a>
                    </li>
                    <li>
                        <span class="contact-icon">📧</span>
                        <a href="mailto:ad@yiru.com.tw">ad@yiru.com.tw</a>
                    </li>
                    <li>
                        <span class="contact-icon">📍</span>
                        <span>台北市內湖區</span>
                    </li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3 class="footer-title">快速連結</h3>
                <ul class="footer-links">
                    <li><a href="#">隱私權政策</a></li>
                    <li><a href="#">使用條款</a></li>
                    <li><a href="#">檔案下載</a></li>
                    <li><a href="#">徵才資訊</a></li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2025 一如永續股份有限公司 版權所有 | All Rights Reserved</p>
        </div>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // All JavaScript from the previous version remains unchanged.
        // It's copied here for completeness.
        const PING_TO_M2 = 3.305785;
        let currentCoords = [25.0355, 121.565]; 
        
        function getLandData() {
            const storedData = sessionStorage.getItem('selectedLand');
            let baseData = {};
            if (storedData) {
                baseData = JSON.parse(storedData);
            }

            const defaults = {
                id: new URLSearchParams(window.location.search).get('landId') || 101,
                title: "臺北市信義區信義段五小段101地號",
                region: "臺北市", district: "信義區", area: 150.5,
                pricePerPing: 165.0,
                landUseZone: "商業區",
                ownerCount: Math.floor(Math.random() * 20) + 1,
                shareNumerator: 1,
                shareDenominator: Math.floor(Math.random() * 20) + 2,
                marketPrice: 175.0
            };
            
            const finalData = { ...defaults, ...baseData };

            if (finalData.ownerCount > 1) {
                 finalData.shareDenominator = Math.max(finalData.shareDenominator, finalData.ownerCount);
                 finalData.shareNumerator = Math.min(finalData.shareNumerator, finalData.shareDenominator);
            } else {
                finalData.shareNumerator = 1;
                finalData.shareDenominator = 1;
            }

            return finalData;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const land = getLandData();

            land.hasBuilding = Math.random() > 0.2;
            if (land.hasBuilding) {
                land.buildingId = Math.floor(Math.random() * 5000) + 10000;
            }

            renderLandTable(land); 
            renderBuildingTable(land); 
            renderRealPriceTable(land); 
            renderExpertAdvice(land);
            
            const shareAnalysisSection = document.querySelector('.share-analysis-section .share-info-grid');
            shareAnalysisSection.innerHTML = `
                <div class="share-info-card">
                    <h4>📊 產權結構分析</h4>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">共有人總數</span><span class="info-value" style="color:#dc2626; font-weight:600;" id="ownerCountDisplay">-</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">您的持分比例</span><span class="info-value" style="font-weight:600;" id="shareRatioDisplay">-</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">實際持分面積</span><span class="info-value" style="color:#059669; font-weight:600;" id="shareAreaDisplay">-</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0;"><span class="info-label" style="color:#64748b; font-size:14px;">產權類型</span><span class="info-value" style="font-weight:600;" id="ownershipTypeDisplay">-</span></div>
                    <div class="ownership-chart" style="margin-top:15px;"><div class="ownership-bar" id="ownershipBar" style="display: flex; height: 30px; border-radius: 6px; overflow: hidden; margin-bottom: 10px;"></div><div class="ownership-legend" id="ownershipLegend" style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 13px;"></div></div>
                </div>
                <div class="share-info-card">
                    <h4>⚖️ 法律權利說明</h4>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">優先購買權</span><span class="info-value" style="color:#059669; font-weight:600;">✓ 享有</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">分割請求權</span><span class="info-value" style="color:#059669; font-weight:600;">✓ 可行使</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">使用收益權</span><span class="info-value" style="color:#f59e0b; font-weight:600;">需協議</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0;"><span class="info-label" style="color:#64748b; font-size:14px;">處分權限</span><span class="info-value" style="font-weight:600;">可單獨出售持分</span></div>
                    <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 6px; font-size: 13px; line-height: 1.6;"><strong style="color: #92400e;">⚠️ 重要提醒：</strong><br>• 出售持分需通知其他共有人<br>• 其他共有人享有優先購買權</div>
                </div>
                <div class="share-info-card">
                    <h4>💰 投資價值評估</h4>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">持分單價</span><span class="info-value" style="font-weight:600;" id="shareUnitPriceDisplay">-</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">完整產權單價</span><span class="info-value" style="font-weight:600;" id="fullPriceDisplay">-</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">價差分析</span><span class="info-value" style="color:#059669; font-weight:600;" id="priceDiffDisplay">-</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0;"><span class="info-label" style="color:#64748b; font-size:14px;">投資總額</span><span class="info-value" style="font-weight:600;" id="totalInvestmentDisplay">-</span></div>
                    <div style="margin-top: 15px; padding: 12px; background: #ecfdf5; border-radius: 6px; font-size: 13px; line-height: 1.6;"><strong style="color: #065f46;">💡 投資建議：</strong><br><span id="investmentAdvice">載入中...</span></div>
                </div>
                <div class="share-info-card">
                    <h4>⚠️ 風險與整合評估</h4>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">整合難度</span><span class="info-value" style="font-weight:600;" id="integrationDifficulty">-</span></div>
                    <div class="risk-meter"><span class="risk-meter-label" id="riskLevel" style="font-size: 12px; font-weight: 600; min-width: 40px;">-</span><div class="risk-meter-bar"><div class="risk-meter-fill" id="riskFill"></div></div></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e0f2f1;"><span class="info-label" style="color:#64748b; font-size:14px;">預估整合時間</span><span class="info-value" style="color:#f59e0b; font-weight:600;" id="integrationTime">-</span></div>
                    <div class="info-row" style="display:flex; justify-content:space-between; padding:10px 0;"><span class="info-label" style="color:#64748b; font-size:14px;">整合成功率</span><span class="info-value" style="font-weight:600;" id="successRate">-</span></div>
                    <div class="integration-strategy" id="integrationStrategy" style="background: #f0fdfa; border: 1px solid #14b8a6; border-radius: 8px; padding: 15px; margin-top: 15px;"></div>
                </div>
            `;
            renderShareAnalysis(land);

            initializeMaps(land); 
            initializeAmenitiesMap();
            initializeStreetView(land); 
        });

        function renderLandTable(land) {
            const areaM2 = land.area * PING_TO_M2;
            const announcedValuePerM2 = Math.round(land.marketPrice * 10000 / PING_TO_M2);
            const shareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0;
            const shareAreaM2 = areaM2 * shareRatio;
            const shareAreaPing = land.area * shareRatio;
            const sharePercentage = (shareRatio * 100).toFixed(2);
            const buildingDisplay = land.hasBuilding ? land.buildingId : '無';
            document.getElementById('landAddress').innerHTML = `<strong>地段: ${land.title}</strong>`;
            document.getElementById('landTableBody').innerHTML = `<tr><td>${land.id}</td><td class="zone-cell">${land.landUseZone}</td><td>${announcedValuePerM2.toLocaleString()}</td><td>${areaM2.toFixed(2)}</td><td>${land.area.toFixed(2)}</td><td>${land.ownerCount}</td><td>${land.shareNumerator}</td><td>${land.shareDenominator}</td><td>${shareAreaM2.toFixed(2)}</td><td>${shareAreaPing.toFixed(2)}</td><td>${sharePercentage}%</td><td>${buildingDisplay}</td></tr><tr class="subtotal-row"><td colspan="3">小計</td><td>${areaM2.toFixed(2)}</td><td>${land.area.toFixed(2)}</td><td colspan="3"></td><td>${shareAreaM2.toFixed(2)}</td><td>${shareAreaPing.toFixed(2)}</td><td>${sharePercentage}%</td><td></td></tr>`;
        }
        function renderBuildingTable(land) {
            if (!land.hasBuilding) { 
                document.getElementById('buildingAddress').innerHTML = '<strong>地址: 無</strong>';
                document.getElementById('buildingTableBody').innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 20px; color: #666;">此筆土地無地上物</td></tr>`; return;
            }
            const buildingAreaPing = (Math.random() * 20 + 10).toFixed(2), buildingAreaM2 = (buildingAreaPing * PING_TO_M2).toFixed(2), buildingOwners = Math.floor(Math.random() * 15) + 1, buildingShareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0, buildingShareAreaM2 = (buildingAreaM2 * buildingShareRatio).toFixed(2), buildingShareAreaPing = (buildingAreaPing * buildingShareRatio).toFixed(2), buildingSharePercentage = (buildingShareRatio * 100).toFixed(2);
            const fullAddress = `${land.region}${land.district}${[ "信義路", "松智路", "莊敬路"][Math.floor(Math.random()*3)]}${Math.floor(Math.random()*200)+1}巷${Math.floor(Math.random()*50)+1}號`;
            document.getElementById('buildingAddress').innerHTML = `<strong>地址: ${fullAddress}</strong>`;
            document.getElementById('buildingTableBody').innerHTML = `<tr><td rowspan="2">${land.buildingId}</td><td>1</td><td rowspan="2">${buildingOwners}</td><td>${(buildingAreaM2 / 2).toFixed(2)}</td><td>${(buildingAreaPing / 2).toFixed(2)}</td><td>${land.shareNumerator}</td><td>${land.shareDenominator}</td><td>${(buildingShareAreaM2 / 2).toFixed(2)}</td><td>${(buildingShareAreaPing / 2).toFixed(2)}</td><td>${buildingSharePercentage}%</td><td rowspan="2"></td></tr><tr><td>2</td><td>${(buildingAreaM2 / 2).toFixed(2)}</td><td>${(buildingAreaPing / 2).toFixed(2)}</td><td>${land.shareNumerator}</td><td>${land.shareDenominator}</td><td>${(buildingShareAreaM2 / 2).toFixed(2)}</td><td>${(buildingShareAreaPing / 2).toFixed(2)}</td><td>${buildingSharePercentage}%</td></tr><tr class="subtotal-row"><td colspan="3">小計</td><td>${buildingAreaM2}</td><td>${buildingAreaPing}</td><td colspan="2"></td><td>${buildingShareAreaM2}</td><td>${buildingShareAreaPing}</td><td>${(parseFloat(buildingSharePercentage) * 2).toFixed(2)}%</td><td></td></tr>`;
        }
        function renderRealPriceTable(land) {
            let contentHTML = '';
            const hardcodedData = [
                { id: 1, lat: 25.040, lng: 121.558, address: "光復南路2xx號", type: "住宅用地", unitPrice: 145.0, area: 45.2, note: "" }, { id: 2, lat: 25.040, lng: 121.560, address: "仁愛路四段505號", type: "公共設施用地", unitPrice: 130.0, area: 150.0, note: "特殊交易" }, { id: 3, lat: 25.037, lng: 121.564, address: "松高路1x號", type: "商業用地", unitPrice: 180.0, area: 120.5, note: "" }, { id: 4, lat: 25.037, lng: 121.566, address: "忠孝東路五段68號", type: "商業用地", unitPrice: 210.0, area: 95.8, note: "" }, { id: 5, lat: 25.035, lng: 121.566, address: "松壽路2x號", type: "商業用地", unitPrice: 148.0, area: 88.0, note: "" }, { id: 6, lat: 25.034, lng: 121.566, address: "松壽路12號", type: "商業用地", unitPrice: 140.0, area: 110.3, note: "" }, { id: 7, lat: 25.033, lng: 121.568, address: "莊敬路1xx號", type: "住宅用地", unitPrice: 125.0, area: 35.6, note: "" }, { id: 8, lat: 25.030, lng: 121.568, address: "莊敬路4xx號", type: "住宅用地", unitPrice: 120.0, area: 40.1, note: "親友交易" }, { id: 9, lat: 25.028, lng: 121.565, address: "吳興街1xx巷", type: "住宅用地", unitPrice: 115.0, area: 28.9, note: "" }
            ];
            window.realPriceData = hardcodedData.map(item => {
                const transactionDate = `114/${String(Math.floor(Math.random() * 5) + 1).padStart(2, '0')}`;
                const totalPrice = item.area * item.unitPrice;
                const typeRaw = item.type;
                return { id: item.id, date: transactionDate, address: item.address, type: typeRaw, typeCategory: typeRaw.includes('住宅') ? 'residential' : typeRaw.includes('商業') ? 'commercial' : 'industrial', totalPrice: totalPrice, area: item.area, unitPrice: item.unitPrice, note: item.note, lat: item.lat, lng: item.lng };
            });
            window.realPriceData.forEach(data => { contentHTML += `<tr><td style="text-align:center"><strong>${data.id}</strong></td><td style="text-align:center">${data.date}</td><td>${data.address}</td><td style="text-align:center">${data.type}</td><td style="text-align:center;font-weight:bold;color:var(--primary-color);">${(data.totalPrice/1000).toFixed(1)} 萬</td><td style="text-align:center">${data.area.toFixed(2)} 坪</td><td style="text-align:center;font-weight:bold;color:var(--primary-color);">${data.unitPrice.toFixed(1)} 萬/坪</td><td style="text-align:center">${data.note}</td></tr>`; });
            document.getElementById('realPriceTableBody').innerHTML = contentHTML;
        }
        let realPriceMapInstance = null;
        let mapMarkers = [];
        function switchRealPriceView(viewType) {
            const tableView = document.getElementById('realPriceTableView');
            const mapView = document.getElementById('realPriceMapView');
            const buttons = document.querySelectorAll('.view-toggle-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            if (viewType === 'table') { tableView.classList.add('active'); mapView.classList.remove('active'); buttons[0].classList.add('active'); } else { tableView.classList.remove('active'); mapView.classList.add('active'); buttons[1].classList.add('active'); if (!realPriceMapInstance) { initRealPriceMap(); } else { setTimeout(() => realPriceMapInstance.invalidateSize(), 10); } }
        }
        function initRealPriceMap() {
             realPriceMapInstance = L.map('realPriceMap').setView(currentCoords, 15);
             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(realPriceMapInstance);
             const targetIcon = L.divIcon({ className: 'target-marker', html: '<div style="background: #dc2626; width: 30px; height: 30px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">📍</div>', iconSize: [30, 30], iconAnchor: [15, 15] });
             L.marker(currentCoords, { icon: targetIcon }).addTo(realPriceMapInstance).bindPopup('<div class="custom-popup"><div class="popup-header">📍 目標土地位置</div></div>');
             updateMapMarkers();
             setTimeout(() => realPriceMapInstance.invalidateSize(), 200);
        }
        function updateMapMarkers() {
             if (!realPriceMapInstance || !window.realPriceData) return;
             mapMarkers.forEach(marker => realPriceMapInstance.removeLayer(marker));
             mapMarkers = [];
             const showResidential = document.getElementById('filterResidential')?.checked ?? true;
             const showCommercial = document.getElementById('filterCommercial')?.checked ?? true;
             const showIndustrial = document.getElementById('filterIndustrial')?.checked ?? true;
             let filteredData = window.realPriceData.filter(data => {
                 if (data.typeCategory === 'residential' && !showResidential) return false;
                 if (data.typeCategory === 'commercial' && !showCommercial) return false;
                 if (data.typeCategory === 'industrial' && !showIndustrial) return false;
                 return true;
             });
             if (filteredData.length > 0) {
                 const prices = filteredData.map(d => d.unitPrice);
                 document.getElementById('mapTransactionCount').textContent = filteredData.length;
                 document.getElementById('mapAvgPrice').textContent = (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(1);
                 document.getElementById('mapMaxPrice').textContent = Math.max(...prices).toFixed(1);
                 document.getElementById('mapMinPrice').textContent = Math.min(...prices).toFixed(1);
             } else {
                 document.getElementById('mapTransactionCount').textContent = 0;
                 document.getElementById('mapAvgPrice').textContent = 0;
                 document.getElementById('mapMaxPrice').textContent = 0;
                 document.getElementById('mapMinPrice').textContent = 0;
             }
             filteredData.forEach(data => {
                 let color = data.unitPrice > 200 ? '#ef4444' : data.unitPrice > 150 ? '#f59e0b' : '#10b981';
                 const markerIcon = L.divIcon({ className: 'price-marker', html: `<div style="background: ${color}; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${data.id}</div>`, iconSize: [28, 28], iconAnchor: [14, 14] });
                 const popupContent = `<div class="custom-popup"><div class="popup-header">地點 ${data.id} - ${data.type}</div><div class="popup-row"><span class="popup-label">單價</span><span class="popup-value popup-price">${data.unitPrice.toFixed(1)} 萬/坪</span></div><div class="popup-row"><span class="popup-label">地址</span><span class="popup-value">${data.address}</span></div></div>`;
                 const marker = L.marker([data.lat, data.lng], { icon: markerIcon }).addTo(realPriceMapInstance).bindPopup(popupContent);
                 mapMarkers.push(marker);
             });
        }
        function renderShareAnalysis(land) {
            const shareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0; const shareAreaPing = land.area * shareRatio; const sharePercentage = (shareRatio * 100).toFixed(2);
            document.getElementById('ownerCountDisplay').innerHTML = `${land.ownerCount} 人`; document.getElementById('shareRatioDisplay').innerHTML = `${land.shareNumerator}/${land.shareDenominator} (${sharePercentage}%)`; document.getElementById('shareAreaDisplay').innerHTML = `${shareAreaPing.toFixed(2)} 坪`;
            let ownershipType = (land.ownerCount === 1) ? '<span style="color: #059669;">單獨所有</span>' : (land.ownerCount <= 3) ? '<span style="color: #f59e0b;">分別共有 (少數)</span>' : (land.ownerCount <= 10) ? '<span style="color: #f59e0b;">分別共有 (中等)</span>' : '<span style="color: #dc2626;">分別共有 (多數)</span>';
            document.getElementById('ownershipTypeDisplay').innerHTML = ownershipType;
            renderOwnershipChart(land);
            const shareUnitPrice = land.pricePerPing; const fullPrice = land.marketPrice; const priceDiff = ((shareUnitPrice / fullPrice - 1) * 100).toFixed(1); const totalInvestment = shareAreaPing * shareUnitPrice;
            document.getElementById('shareUnitPriceDisplay').innerHTML = `${shareUnitPrice.toFixed(1)} 萬/坪`; document.getElementById('fullPriceDisplay').innerHTML = `${fullPrice.toFixed(1)} 萬/坪`;
            if (priceDiff < 0) { document.getElementById('priceDiffDisplay').innerHTML = `折價 ${Math.abs(priceDiff)}% <span style="color: #059669;">✓ 划算</span>`; } else { document.getElementById('priceDiffDisplay').innerHTML = `溢價 ${priceDiff}% <span style="color: #dc2626;">⚠️ 偏高</span>`; }
            document.getElementById('totalInvestmentDisplay').innerHTML = `${(totalInvestment).toFixed(1)} 萬`;
            document.getElementById('investmentAdvice').innerHTML = (priceDiff < -20) ? `持分價格較市場行情<strong style="color: #059669;">低 ${Math.abs(priceDiff)}%</strong>，具投資價值。` : (priceDiff < -10) ? `持分價格<strong style="color: #059669;">合理偏低</strong>，若整合成功可獲利。` : `持分價格<strong style="color: #dc2626;">偏高</strong>，建議重新議價。`;
            let difficulty, riskLevel, riskColor, riskWidth, integrationTime, successRate;
            if (land.ownerCount === 1) { difficulty = '<span style="color: #059669;">無需整合</span>'; riskLevel = '低風險'; riskColor = 'low'; riskWidth = '20%'; integrationTime = '立即可用'; successRate = '<span style="color: #059669;">100%</span>'; } else if (land.ownerCount <= 3) { difficulty = '<span style="color: #059669;">容易</span>'; riskLevel = '低風險'; riskColor = 'low'; riskWidth = '30%'; integrationTime = '3-6 個月'; successRate = '<span style="color: #059669;">80-90%</span>'; } else if (land.ownerCount <= 10) { difficulty = '<span style="color: #f59e0b;">中等</span>'; riskLevel = '中風險'; riskColor = 'medium'; riskWidth = '60%'; integrationTime = '6-18 個月'; successRate = '<span style="color: #f59e0b;">50-70%</span>'; } else { difficulty = '<span style="color: #dc2626;">困難</span>'; riskLevel = '高風險'; riskColor = 'high'; riskWidth = '90%'; integrationTime = '1.5-5 年+'; successRate = '<span style="color: #dc2626;">20-40%</span>'; }
            document.getElementById('integrationDifficulty').innerHTML = difficulty; document.getElementById('riskLevel').textContent = riskLevel; document.getElementById('riskFill').className = `risk-meter-fill ${riskColor}`; document.getElementById('riskFill').style.width = riskWidth; document.getElementById('integrationTime').innerHTML = integrationTime; document.getElementById('successRate').innerHTML = successRate;
            renderIntegrationStrategy(land);
        }
        function renderOwnershipChart(land) {
            const bar = document.getElementById('ownershipBar'); const legend = document.getElementById('ownershipLegend'); const shareRatio = land.shareDenominator > 0 ? (land.shareNumerator / land.shareDenominator) : 0; const yourShare = shareRatio * 100; const othersShare = 100 - yourShare;
            bar.innerHTML = `<div style="width: ${yourShare}%; background: #10b981; display:flex; align-items:center; justify-content:center; color:white; font-size:12px; font-weight:600;">您 ${yourShare.toFixed(1)}%</div><div style="width: ${othersShare}%; background: #94a3b8; display:flex; align-items:center; justify-content:center; color:white; font-size:12px; font-weight:600;">其他 ${land.ownerCount - 1} 人</div>`;
            legend.innerHTML = `<div style="display:flex; align-items:center; gap:6px;"><div style="width:16px; height:16px; background:#10b981; border-radius:3px;"></div><span>您的持分</span></div><div style="display:flex; align-items:center; gap:6px;"><div style="width:16px; height:16px; background:#94a3b8; border-radius:3px;"></div><span>其他共有人</span></div>`;
        }
        function renderIntegrationStrategy(land) {
             const container = document.getElementById('integrationStrategy'); let strategies = (land.ownerCount === 1) ? ['產權完整，無需整合', '可立即進行開發規劃'] : (land.ownerCount <= 3) ? ['逐一拜訪其他共有人了解意願', '可考慮全部收購或協議開發'] : (land.ownerCount <= 10) ? ['先找出主要持分者進行溝通', '評估是否有人已在收購持分'] : ['⚠️ 整合難度極高，需謹慎評估', '建議先調查是否有大股東', '評估訴訟分割的可行性'];
             let html = '<h5 style="color:#0f766e; font-size:1rem; margin-bottom:10px;">🎯 整合策略建議</h5><ul style="list-style:none; padding-left:0;">'; strategies.forEach(strategy => { html += `<li style="padding: 5px 0 5px 20px; position: relative; font-size: 14px;"><span style="position: absolute; left: 0; color: #10b981; font-weight: bold;">✓</span>${strategy}</li>`; }); html += '</ul>'; container.innerHTML = html;
        }
        function renderExpertAdvice(land) {
            const adviceContainer = document.getElementById('expertAdviceContent'); let strengths = '', risks = '', recommendation = ''; const priceDiff = land.pricePerPing - land.marketPrice, priceDiffPercent = (priceDiff / land.marketPrice) * 100;
            if (priceDiff < 0) { strengths += `<li><strong>價格優勢:</strong> 開價單價 <span style="color:#059669; font-weight:bold;">${land.pricePerPing} 萬/坪</span>, 低於鄰近均價 <span style="color:#059669; font-weight:bold;">${Math.abs(priceDiffPercent).toFixed(1)}%</span>。</li>`; } else { risks += `<li><strong>價格偏高:</strong> 開價單價 <span style="color:#c62828; font-weight:bold;">${land.pricePerPing} 萬/坪</span>, 高於鄰近均價 <span style="color:#c62828; font-weight:bold;">${priceDiffPercent.toFixed(1)}%</span>。</li>`; }
            if (land.landUseZone.includes('商') || land.landUseZone.includes('住')) { strengths += `<li><strong>分區潛力:</strong> 土地使用分區為 <span style="color:#059669; font-weight:bold;">${land.landUseZone}</span>, 價值高。</li>`; }
            if (land.ownerCount > 10) { risks += `<li><strong>產權複雜:</strong> 所有權人高達 <span style="color:#c62828; font-weight:bold;">${land.ownerCount}人</span>, 整合<span style="color:#c62828; font-weight:bold;">難度極高</span>。</li>`; } else if (land.ownerCount > 1) { risks += `<li><strong>產權持分:</strong> 所有權人數為 <span style="color:#f59e0b; font-weight:bold;">${land.ownerCount}人</span>, 需整合。</li>`; } else { strengths += `<li><strong>產權單純:</strong> <span style="color:#059669; font-weight:bold;">產權完整</span>。</li>`; }
            if (land.hasBuilding) { risks += `<li><strong>地上物處理:</strong> 土地上<span style="color:#c62828; font-weight:bold;">存有地上物</span>, 需考量後續處理成本。</li>`; }
            recommendation = `<p>此案最大挑戰在於<span style="color:#c62828; font-weight:bold;">${land.ownerCount > 1 ? `產權整合` : `價格`}</span>。建議投資人${land.ownerCount > 10 ? `若無豐富整合經驗, 應謹慎評估。` : `可積極出價, 並將${land.hasBuilding ? '地上物處理與' : ''}整合成本納入總預算。`}</p>`;
            adviceContainer.innerHTML = `<h3 style="font-size: 1.2rem; color: #0f766e; margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #a7ffeb;">一、優勢分析</h3><ul style="list-style:none; padding-left:0; margin-bottom:1rem;">${strengths || "<li>尚無顯著優勢</li>"}</ul><h3 style="font-size: 1.2rem; color: #0f766e; margin-top:15px; margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #a7ffeb;">二、風險評估</h3><ul style="list-style:none; padding-left:0; margin-bottom:1rem;">${risks || "<li>尚無顯著風險</li>"}</ul><h3 style="font-size: 1.2rem; color: #0f766e; margin-top:15px; margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #a7ffeb;">三、綜合建議</h3>${recommendation}`;
        }
        
        function initializeMaps(land) {
            const coords = currentCoords;
            const zoningMap = L.map('zoningMap').setView(coords, 16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(zoningMap); L.polygon([[coords[0] + 0.001, coords[1] - 0.001], [coords[0] + 0.001, coords[1] + 0.001], [coords[0] - 0.001, coords[1] + 0.001], [coords[0] - 0.001, coords[1] - 0.001]], { color: '#DC2626', fillColor: '#ffcdd2', fillOpacity: 0.5 }).addTo(zoningMap).bindPopup(`使用分區:${land.landUseZone}<br>面積:${land.area}坪`);
            const cadastralMap = L.map('cadastralMap').setView(coords, 17); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(cadastralMap); L.marker(coords).addTo(cadastralMap).bindPopup(`地號:${land.id}<br>${land.title}`); L.polygon([[coords[0] + 0.0008, coords[1] - 0.0008], [coords[0] + 0.0008, coords[1] + 0.0008], [coords[0] - 0.0008, coords[1] + 0.0008], [coords[0] - 0.0008, coords[1] - 0.0008]], { color: '#2563eb', weight: 2, fillOpacity: 0.1 }).addTo(cadastralMap);
            const topographicMap = L.map('topographicMap').setView(coords, 15); L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png').addTo(topographicMap); L.marker(coords).addTo(topographicMap).bindPopup(`地形位置<br>${land.region}${land.district}`);
            const aerialMap = L.map('aerialMap').setView(coords, 18); L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(aerialMap); L.circle(coords, { color: '#059669', fillColor: '#10b981', fillOpacity: 0.3, radius: 50 }).addTo(aerialMap).bindPopup('土地位置');
            const overlayMap = L.map('overlayMap').setView(coords, 16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(overlayMap); L.polygon([[coords[0] + 0.001, coords[1] - 0.001], [coords[0] + 0.001, coords[1] + 0.001], [coords[0] - 0.001, coords[1] + 0.001], [coords[0] - 0.001, coords[1] - 0.001]], { color: '#DC2626', fillColor: '#ffcdd2', fillOpacity: 0.4 }).addTo(overlayMap); L.polygon([[coords[0] + 0.0008, coords[1] - 0.0008], [coords[0] + 0.0008, coords[1] + 0.0008], [coords[0] - 0.0008, coords[1] + 0.0008], [coords[0] - 0.0008, coords[1] - 0.0008]], { color: '#2563eb', weight: 2, fillOpacity: 0 }).addTo(overlayMap); L.marker(coords).addTo(overlayMap).bindPopup('多圖層套圖預覽。<br>點擊上方按鈕開啟全功能分析。').openPopup();

            setTimeout(function() {
                zoningMap.invalidateSize();
                cadastralMap.invalidateSize();
                topographicMap.invalidateSize();
                aerialMap.invalidateSize();
                overlayMap.invalidateSize();
            }, 200);
        }
        function initializeAmenitiesMap() {
            const coords = currentCoords;
            const amenitiesMap = L.map('amenitiesMap').setView(coords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(amenitiesMap);
            const amenitiesData = [ { name: '捷運市政府站', type: 'transport', lat: 25.0408, lng: 121.5645, icon: '🚇', color: '#0288d1' }, { name: '捷運台北101/世貿站', type: 'transport', lat: 25.0339, lng: 121.5645, icon: '🚇', color: '#0288d1' }, { name: '市府轉運站', type: 'transport', lat: 25.0403, lng: 121.5652, icon: '🚌', color: '#0288d1' }, { name: '臺北市信義區信義國民小學', type: 'school', lat: 25.0359, lng: 121.5701, icon: '🏫', color: '#f57c00' }, { name: '臺北市立信義國民中學', type: 'school', lat: 25.0318, lng: 121.5698, icon: '🏫', color: '#f57c00' }, { name: '博愛國小', type: 'school', lat: 25.0375, lng: 121.5714, icon: '🏫', color: '#f57c00' }, { name: '信義廣場 (中強公園)', type: 'park', lat: 25.0315, lng: 121.5665, icon: '🌳', color: '#388e3c' }, { name: '國父紀念館', type: 'park', lat: 25.0405, lng: 121.5592, icon: '🌳', color: '#388e3c' }, { name: '新光三越 台北信義新天地', type: 'shopping', lat: 25.0373, lng: 121.5663, icon: '🛍️', color: '#d32f2f' }, { name: '台北101購物中心', type: 'shopping', lat: 25.0336, lng: 121.5647, icon: '🛍️', color: '#d32f2f' }, { name: '微風信義', type: 'shopping', lat: 25.0390, lng: 121.5660, icon: '🛍️', color: '#d32f2f' }, { name: '臺北醫學大學附設醫院', type: 'medical', lat: 25.0261, lng: 121.5617, icon: '🏥', color: '#7b1fa2' }, { name: '信義運動中心', type: 'medical', lat: 25.0321, lng: 121.5715, icon: '💪', color: '#7b1fa2' } ];
            const targetIcon = L.divIcon({ className: 'target-marker', html: '<div style="background: #dc2626; width: 30px; height: 30px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">📍</div>', iconSize: [30, 30], iconAnchor: [15, 15] });
            L.marker(coords, { icon: targetIcon, zIndexOffset: 1000 }).addTo(amenitiesMap).bindPopup('<div class="custom-popup"><div class="popup-header">📍 目標土地位置</div></div>');
            const layers = { transport: L.layerGroup(), school: L.layerGroup(), park: L.layerGroup(), shopping: L.layerGroup(), medical: L.layerGroup() };
            amenitiesData.forEach(amenity => {
                if (!layers[amenity.type]) return;
                const amenityIcon = L.divIcon({ className: 'amenity-marker', html: `<div style="background-color:${amenity.color};" class="amenity-marker">${amenity.icon}</div>`, iconSize: [32, 32], iconAnchor: [16, 16] });
                L.marker([amenity.lat, amenity.lng], { icon: amenityIcon }).bindPopup(amenity.name).addTo(layers[amenity.type]);
            });
            document.querySelectorAll('.amenities-controls input[type="checkbox"]:checked').forEach(checkbox => { if (layers[checkbox.dataset.layer]) { layers[checkbox.dataset.layer].addTo(amenitiesMap); } });
            document.querySelectorAll('.amenities-controls input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const layerName = e.target.dataset.layer;
                    if (layers[layerName]) { e.target.checked ? amenitiesMap.addLayer(layers[layerName]) : amenitiesMap.removeLayer(layers[layerName]); }
                });
            });

            setTimeout(function() { amenitiesMap.invalidateSize(); }, 200);
        }
        function initializeStreetView(land) {
            const coords = currentCoords;
            const streetviewMap = L.map('streetviewContainer').setView(coords, 18); L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(streetviewMap);
            const marker = L.marker(coords).addTo(streetviewMap); const streetviewUrl = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${coords[0]},${coords[1]}`;
            marker.bindPopup(`<div style="text-align: center;"><strong>${land.title}</strong><br><a href="${streetviewUrl}" target="_blank" style="display:inline-block;margin-top:10px;padding:8px 16px;background:linear-gradient(135deg, #4285f4 0%, #34a853 100%);color:white;text-decoration:none;border-radius:6px;font-weight:600;">🌐 開啟 Google 街景</a></div>`).openPopup();
            L.circle(coords, { color: '#4285f4', fillColor: '#4285f4', fillOpacity: 0.2, radius: 30 }).addTo(streetviewMap);
            
            setTimeout(function() { streetviewMap.invalidateSize(); }, 200);
        }
        function openExternalMap(mapType) { let url = `https://www.openstreetmap.org/#map=17/${currentCoords[0]}/${currentCoords[1]}`; if (mapType === 'aerial') { url = `https://www.google.com/maps/@${currentCoords[0]},${currentCoords[1]},18z/data=!3m1!1e3`; } window.open(url, '_blank'); }
    </script>
</body>
</html>