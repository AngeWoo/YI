<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡ˆä»¶é€²åº¦ç®¡ç†ç³»çµ±</title>
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            color: #333;
        }
        .manager-container { display: flex; flex-direction: column; min-height: 100vh; }

        /* Header */
        .manager-header {
            background: white;
            padding: 15px 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        /* MODIFICATION START: Logo Container Styles */
        .title-container-mgr {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-mgr {
            width: 50px;
            height: auto;
        }
        /* MODIFICATION END */

        .manager-header h1 { color: #DC2626; font-size: 1.8rem; }
        .header-nav a {
            padding: 8px 20px;
            background: #f0f0f0;
            color: #DC2626;
            text-decoration: none;
            border: 2px solid #f0f0f0;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .header-nav a:hover { border: 2px solid #DC2626; background: white; }

        .main-content { padding: 25px 40px; }

        /* Reports Section */
        .reports-section {
            margin-bottom: 30px;
        }
        .section-title { font-size: 1.5rem; color: #333; margin-bottom: 20px; border-bottom: 3px solid #DC2626; padding-bottom: 10px;}
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .kpi-card .title { font-size: 0.9rem; color: #666; margin-bottom: 10px; }
        .kpi-card .value { font-size: 2.2rem; font-weight: bold; }
        .kpi-card .value.price { color: #4CAF50; }
        .kpi-card .value.rate { color: #2196F3; }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .chart-container h3 { margin-bottom: 15px; text-align: center; }

        /* Kanban Board */
        .kanban-board {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 20px;
            min-height: 500px;
        }
        .kanban-column {
            flex: 1 0 300px;
            background: #e9ecef;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        .kanban-column-header {
            padding: 15px;
            font-weight: 600;
            font-size: 1rem;
            border-bottom: 3px solid;
            display: flex;
            justify-content: space-between;
        }
        .kanban-cards {
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            min-height: 100px;
        }
        .kanban-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            cursor: grab;
            border-left: 5px solid;
        }
        .kanban-card:active { cursor: grabbing; }
        .kanban-card.dragging { opacity: 0.5; }

        .card-title { font-weight: bold; margin-bottom: 8px; font-size: 0.95rem; }
        .card-info { font-size: 0.8rem; color: #777; margin-bottom: 12px; }
        .card-latest-milestone {
            font-size: 0.85rem;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            color: #555;
            margin-bottom: 12px;
        }
        .card-actions { display: flex; gap: 8px; }
        .card-btn {
            flex: 1;
            padding: 6px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-log { background: #007bff; color: white; }
        .btn-details { background: #6c757d; color: white; }
        
        /* Stage Colors */
        .stage-new-case { border-color: #6c757d; }
        .stage-initial-contact { border-color: #007bff; }
        .stage-site-visit { border-color: #fd7e14; }
        .stage-negotiating { border-color: #ffc107; }
        .stage-closed-won { border-color: #28a745; }
        .stage-closed-lost { border-color: #dc3545; }

        .count-badge { background: #fff; color: #333; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }
        
        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none; align-items: center;
            justify-content: center; z-index: 2000;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: white; border-radius: 12px; width: 90%; max-width: 500px;
        }
        .modal-header {
            padding: 15px 25px; border-bottom: 1px solid #dee2e6;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { font-size: 1.2rem; }
        .close-modal-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; }
        .modal-body { padding: 25px; }
        .form-field { margin-bottom: 15px; }
        .form-field label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .form-field input, .form-field select, .form-field textarea {
            width: 100%; padding: 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #ced4da;
        }
        .form-field textarea { min-height: 100px; resize: vertical; }
        .modal-footer {
            padding: 15px 25px; border-top: 1px solid #dee2e6; text-align: right;
        }
        .modal-btn {
            padding: 10px 20px; border-radius: 6px; border: none;
            cursor: pointer; font-weight: 600;
        }
        .btn-save { background-color: #28a745; color: white; }
        .btn-cancel { background-color: #6c757d; color: white; margin-left: 10px;}

        /* Responsive */
        @media (max-width: 992px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .main-content, .manager-header { padding: 15px 20px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
        }

    </style>
</head>
<body>
    <div class="manager-container">
        <header class="manager-header">
            <!-- MODIFICATION START: Added Logo and container -->
            <div class="title-container-mgr">
                <img src="logo.png" alt="ä¸€å¦‚ YIRU Logo" class="logo-mgr">
                <h1>ğŸ“ˆ æ¡ˆä»¶é€²åº¦ç®¡ç†</h1>
            </div>
            <!-- MODIFICATION END -->
            <nav class="header-nav">
                <a href="indexbackend.html">è¿”å›åœŸåœ°åˆ—è¡¨</a>
            </nav>
        </header>

        <main class="main-content">
            <!-- Reports Section -->
            <section class="reports-section">
                <h2 class="section-title">çµ±è¨ˆå ±è¡¨</h2>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="title">ç¸½æ¡ˆä»¶æ•¸</div><div class="value" id="kpi-total-cases">0</div></div>
                    <div class="kpi-card"><div class="title">ç¸½æˆäº¤é‡‘é¡ (è¬)</div><div class="value price" id="kpi-total-value">0</div></div>
                    <div class="kpi-card"><div class="title">æˆäº¤ç‡</div><div class="value rate" id="kpi-win-rate">0%</div></div>
                    <div class="kpi-card"><div class="title">å¹³å‡æˆäº¤é‡‘é¡ (è¬)</div><div class="value price" id="kpi-avg-value">0</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>æ¡ˆä»¶éšæ®µåˆ†ä½ˆ</h3>
                        <canvas id="stageDistributionChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>æ¥­å‹™å°ˆå“¡ç¸¾æ•ˆ</h3>
                        <canvas id="agentPerformanceChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Kanban Board Section -->
            <section class="kanban-section">
                <h2 class="section-title">æ¡ˆä»¶é€²åº¦çœ‹æ¿</h2>
                <div class="kanban-board" id="kanbanBoard">
                    <!-- Columns will be generated by JavaScript -->
                </div>
            </section>
        </main>
    </div>

    <!-- Milestone Modal -->
    <div class="modal-overlay" id="milestoneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">è¨˜éŒ„é€²åº¦</h2>
                <button class="close-modal-btn" onclick="closeMilestoneModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalLandId">
                <div class="form-field">
                    <label for="milestoneDate">æ—¥æœŸ</label>
                    <input type="date" id="milestoneDate">
                </div>
                <div class="form-field">
                    <label for="milestoneCategory">åˆ†é¡</label>
                    <select id="milestoneCategory">
                        <option value="é›»è©±è¯ç¹«">é›»è©±è¯ç¹«</option>
                        <option value="éƒµä»¶æºé€š">éƒµä»¶æºé€š</option>
                        <option value="ç¾å ´å‹˜æŸ¥">ç¾å ´å‹˜æŸ¥</option>
                        <option value="æœƒè­°">æœƒè­°</option>
                        <option value="å ±åƒ¹">å ±åƒ¹</option>
                        <option value="è­°åƒ¹">è­°åƒ¹</option>
                        <option value="ç°½ç´„">ç°½ç´„</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="milestoneDescription">è©³ç´°èªªæ˜</label>
                    <textarea id="milestoneDescription" placeholder="è«‹è¨˜éŒ„è©³ç´°çš„è™•ç†éç¨‹..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-save" onclick="saveMilestone()">å„²å­˜ç´€éŒ„</button>
                <button class="modal-btn btn-cancel" onclick="closeMilestoneModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>


    <script>
        let allLands = [];
        const salesAgents = [ // This should ideally be fetched or shared, but we define it here for simplicity
            { id: 1, name: 'ç‹å°æ˜' }, { id: 2, name: 'æç¾è¯' }, { id: 3, name: 'é™³å»ºåœ‹' },
            { id: 4, name: 'æ—æ·‘èŠ¬' }, { id: 5, name: 'å¼µå¿—å‰' }, { id: 6, name: 'é»ƒé›…çª' }
        ];

        const stages = [
            { id: 'new-case', title: 'æ–°æ¡ˆä»¶', color: '#6c757d' },
            { id: 'initial-contact', title: 'åˆæ­¥æ¥è§¸', color: '#007bff' },
            { id: 'site-visit', title: 'ç¾å ´å‹˜æŸ¥', color: '#fd7e14' },
            { id: 'negotiating', title: 'è­°åƒ¹ä¸­', color: '#ffc107' },
            { id: 'closed-won', title: 'å·²æˆäº¤', color: '#28a745' },
            { id: 'closed-lost', title: 'å·²æµå¤±', color: '#dc3545' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            if(allLands && allLands.length > 0) {
                renderAll();
            } else {
                document.querySelector('.main-content').innerHTML = `
                    <h2 style="color: red;">æ‰¾ä¸åˆ°æ¡ˆä»¶è³‡æ–™ï¼</h2>
                    <p>è«‹å…ˆè¿”å›<a href="indexbackend.html">åœŸåœ°ç®¡ç†å¾Œå°</a>ä»¥ç”Ÿæˆæ¨¡æ“¬è³‡æ–™ã€‚</p>
                `;
            }
        });

        function loadData() {
            const storedData = localStorage.getItem('allLandsData');
            if (storedData) {
                allLands = JSON.parse(storedData);
            }
        }

        function saveData() {
            localStorage.setItem('allLandsData', JSON.stringify(allLands));
        }
        
        function renderAll() {
            renderKanbanBoard();
            renderReports();
        }

        // Kanban Board Logic
        function renderKanbanBoard() {
            const kanbanBoard = document.getElementById('kanbanBoard');
            kanbanBoard.innerHTML = '';

            stages.forEach(stage => {
                const column = document.createElement('div');
                column.className = 'kanban-column';
                column.setAttribute('data-stage-id', stage.id);

                const landsInStage = allLands.filter(land => land.stage === stage.id);

                column.innerHTML = `
                    <div class="kanban-column-header stage-${stage.id}">
                        <span>${stage.title}</span>
                        <span class="count-badge">${landsInStage.length}</span>
                    </div>
                    <div class="kanban-cards"></div>
                `;

                const cardsContainer = column.querySelector('.kanban-cards');
                landsInStage.forEach(land => {
                    cardsContainer.appendChild(createKanbanCard(land));
                });

                // Drag and Drop events
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(cardsContainer, e.clientY);
                    const draggable = document.querySelector('.dragging');
                    if (afterElement == null) {
                        cardsContainer.appendChild(draggable);
                    } else {
                        cardsContainer.insertBefore(draggable, afterElement);
                    }
                });

                column.addEventListener('drop', e => {
                    e.preventDefault();
                    const landId = e.dataTransfer.getData('text/plain');
                    const droppedLand = allLands.find(l => l.id == landId);
                    if (droppedLand) {
                        droppedLand.stage = stage.id;
                        saveData();
                        renderAll(); // Re-render everything to update counts and reports
                    }
                });

                kanbanBoard.appendChild(column);
            });
        }

        function createKanbanCard(land) {
            const card = document.createElement('div');
            card.className = `kanban-card stage-${land.stage}`;
            card.setAttribute('draggable', true);
            card.setAttribute('data-land-id', land.id);

            const agent = salesAgents.find(a => a.id === land.assignedAgent);
            const latestMilestone = land.milestones[land.milestones.length - 1];

            card.innerHTML = `
                <div class="card-title">${land.title}</div>
                <div class="card-info">æ¥­å‹™: ${agent ? agent.name : 'æœªæŒ‡æ´¾'} | ç¸½åƒ¹: ${land.totalPrice.toLocaleString()}è¬</div>
                <div class="card-latest-milestone">
                    <strong>æœ€æ–°é€²åº¦:</strong> ${latestMilestone.description} (${latestMilestone.date})
                </div>
                <div class="card-actions">
                    <button class="card-btn btn-log" onclick="openMilestoneModal(${land.id})">è¨˜éŒ„é€²åº¦</button>
                    <a href="indexbackend.html" class="card-btn btn-details" style="text-align:center;text-decoration:none;">æŸ¥çœ‹è©³æƒ…</a>
                </div>
            `;
            
            card.addEventListener('dragstart', e => {
                card.classList.add('dragging');
                e.dataTransfer.setData('text/plain', land.id);
            });

            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
            });

            return card;
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Milestone Modal Logic
        function openMilestoneModal(landId) {
            const modal = document.getElementById('milestoneModal');
            const land = allLands.find(l => l.id === landId);
            document.getElementById('modalTitle').textContent = `è¨˜éŒ„é€²åº¦ - ${land.title}`;
            document.getElementById('modalLandId').value = landId;
            document.getElementById('milestoneDate').value = new Date().toISOString().split('T')[0];
            modal.classList.add('show');
        }

        function closeMilestoneModal() {
            document.getElementById('milestoneModal').classList.remove('show');
        }

        function saveMilestone() {
            const landId = document.getElementById('modalLandId').value;
            const land = allLands.find(l => l.id == landId);
            if(land) {
                land.milestones.push({
                    date: document.getElementById('milestoneDate').value,
                    category: document.getElementById('milestoneCategory').value,
                    description: document.getElementById('milestoneDescription').value.trim()
                });
                saveData();
                renderKanbanBoard();
                closeMilestoneModal();
            }
        }
        
        // Reports Logic
        let stageChart, agentChart;
        function renderReports() {
            // KPIs
            const totalCases = allLands.length;
            const closedWonCases = allLands.filter(l => l.stage === 'closed-won');
            const closedCases = allLands.filter(l => l.stage === 'closed-won' || l.stage === 'closed-lost');
            const totalValue = closedWonCases.reduce((sum, l) => sum + l.totalPrice, 0);
            const winRate = closedCases.length > 0 ? (closedWonCases.length / closedCases.length * 100) : 0;
            const avgValue = closedWonCases.length > 0 ? totalValue / closedWonCases.length : 0;

            document.getElementById('kpi-total-cases').textContent = totalCases;
            document.getElementById('kpi-total-value').textContent = Math.round(totalValue).toLocaleString();
            document.getElementById('kpi-win-rate').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('kpi-avg-value').textContent = Math.round(avgValue).toLocaleString();

            // Stage Distribution Chart
            const stageCtx = document.getElementById('stageDistributionChart').getContext('2d');
            const stageCounts = stages.map(stage => allLands.filter(l => l.stage === stage.id).length);
            if(stageChart) stageChart.destroy();
            stageChart = new Chart(stageCtx, {
                type: 'bar',
                data: {
                    labels: stages.map(s => s.title),
                    datasets: [{
                        label: 'æ¡ˆä»¶æ•¸é‡',
                        data: stageCounts,
                        backgroundColor: stages.map(s => s.color)
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // Agent Performance Chart
            const agentCtx = document.getElementById('agentPerformanceChart').getContext('2d');
            const agentPerformance = salesAgents.map(agent => {
                return {
                    name: agent.name,
                    total: allLands.filter(l => l.assignedAgent === agent.id).length,
                    won: allLands.filter(l => l.assignedAgent === agent.id && l.stage === 'closed-won').length
                };
            });
            if(agentChart) agentChart.destroy();
            agentChart = new Chart(agentCtx, {
                type: 'doughnut',
                data: {
                    labels: agentPerformance.map(a => `${a.name} (æˆäº¤ ${a.won} / ç¸½è¨ˆ ${a.total})`),
                    datasets: [{
                        label: 'è² è²¬æ¡ˆä»¶æ•¸',
                        data: agentPerformance.map(a => a.total),
                        backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#673AB7', '#E91E63']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }
    </script>
</body>
</html>```